<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>GP&#39;s Okular Build: How to implement a Generator</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">GP&#39;s Okular Build
   </div>
   <div id="projectbrief">POSE 2014</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('okular_generators.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(12)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(13)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">How to implement a Generator </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The power of <a class="el" href="namespaceOkular.html">Okular</a> is its extensibility by Generator plugins. This section will describe how to implement your own plugin for a new document type.</p>
<ul>
<li><a class="el" href="okular_generators.html#okular_generators_basic">A Basic Generator</a> </li>
<li><a class="el" href="okular_generators.html#okular_generators_with_text">A Generator with TextPage support</a> </li>
<li><a class="el" href="okular_generators.html#okular_generators_threaded">A Generator with Thread support</a> </li>
<li><a class="el" href="okular_generators.html#okular_generators_extended">An Extended Generator</a></li>
</ul>
<h1><a class="anchor" id="okular_generators_basic"></a>
A Basic Generator</h1>
<p>To provide a short overview and don't reimplementing an existing generator we'll work on a Generator for the Magic document format, a non existing, pure virtual format :)</p>
<p>Lets assume we have some helper class (MagicDocument) which provides the following functionality for this document format:</p>
<ul>
<li>Loading a document </li>
<li>Retrieving number of pages </li>
<li>Returning a fixed size picture representation of a page</li>
</ul>
<p>The class API looks like this</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>MagicDocument</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">public</span>:</div>
<div class="line">        MagicDocument();</div>
<div class="line">        ~MagicDocument();</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">bool</span> loadDocument( <span class="keyword">const</span> QString &amp;fileName );</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">int</span> numberOfPages() <span class="keyword">const</span>;</div>
<div class="line"></div>
<div class="line">        QSize <a class="code" href="classpageSize.html">pageSize</a>( <span class="keywordtype">int</span> pageNumber ) <span class="keyword">const</span>;</div>
<div class="line"></div>
<div class="line">        QImage pictureOfPage( <span class="keywordtype">int</span> pageNumber ) <span class="keyword">const</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">private</span>:</div>
<div class="line">        ...</div>
<div class="line">};</div>
</div><!-- fragment --><p>The methods should be self explaining, loadDocument() loads a document file and returns false on error, numberOfPages() returns the number of pages, <a class="el" href="classpageSize.html">pageSize()</a> returns the size of the page and pictureOfPage() returns the picture representation of the page.</p>
<p>Our first version of our Generator is a basic one which just provides page pictures to the document class.</p>
<p>The API of the Generator looks like the following:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;magicdocument.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;okular/core/generator.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>MagicGenerator : <span class="keyword">public</span> <a class="code" href="classOkular_1_1Generator.html">Okular::Generator</a></div>
<div class="line">{</div>
<div class="line">    <span class="keyword">public</span>:</div>
<div class="line">        MagicGenerator( QObject *parent, <span class="keyword">const</span> QVariantList &amp;args );</div>
<div class="line">        ~MagicGenerator();</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">bool</span> <a class="code" href="classOkular_1_1Generator.html#a388b47328a5297d53cdbdc6fcf074ee3">loadDocument</a>( <span class="keyword">const</span> QString &amp;fileName, QVector&lt;Okular::Page*&gt; &amp;pages );</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">bool</span> <a class="code" href="classOkular_1_1Generator.html#abbf00927221e2d2b2b71101f2b7f5732">canGeneratePixmap</a>() <span class="keyword">const</span>;</div>
<div class="line">        <span class="keywordtype">void</span> <a class="code" href="classOkular_1_1Generator.html#a198cdcd9c27b179562c935342fd457b6">generatePixmap</a>( <a class="code" href="classOkular_1_1PixmapRequest.html">Okular::PixmapRequest</a> *request );</div>
<div class="line"></div>
<div class="line">    <span class="keyword">protected</span>:</div>
<div class="line">        <span class="keywordtype">bool</span> <a class="code" href="classOkular_1_1Generator.html#ad3f1dcb98f3bd87c87ad0e91ecf4a6d7">doCloseDocument</a>();</div>
<div class="line"></div>
<div class="line">    <span class="keyword">private</span>:</div>
<div class="line">        MagicDocument mMagicDocument;</div>
<div class="line">};</div>
</div><!-- fragment --><p>The implementation of the Generator looks like this:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;okular/core/page.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;magicgenerator.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> KAboutData createAboutData()</div>
<div class="line">{</div>
<div class="line">    KAboutData aboutData(...);</div>
<div class="line">    <span class="comment">// fill the about data</span></div>
<div class="line">    <span class="keywordflow">return</span> aboutData;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><a class="code" href="generator_8h.html#a87d954a3809f78e33fb1cb8e2369a05c">OKULAR_EXPORT_PLUGIN</a>(MagicGenerator, createAboutData())</div>
<div class="line"></div>
<div class="line">MagicGenerator::MagicGenerator( QObject *parent, const QVariantList &amp;args )</div>
<div class="line">    : Okular::Generator( parent, args )</div>
<div class="line">{</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">MagicGenerator::~MagicGenerator()</div>
<div class="line">{</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> MagicGenerator::loadDocument( <span class="keyword">const</span> QString &amp;fileName, QVector&lt;Okular::Page*&gt; &amp;pages )</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> ( !mMagicDocument.loadDocument( fileName ) ) {</div>
<div class="line">        emit error( i18n( <span class="stringliteral">&quot;Unable to load document&quot;</span> ), -1 );</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    pagesVector.resize( mMagicDocument.numberOfPages() );</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; mMagicDocument.numberOfPages(); ++i ) {</div>
<div class="line">      <span class="keyword">const</span> QSize <a class="code" href="synctex__parser_8c.html#aa23c661441688350614bd6a350d2b6ff">size</a> = mMagicDocument.pageSize( i );</div>
<div class="line"></div>
<div class="line">      <a class="code" href="classOkular_1_1Page.html">Okular::Page</a> * page = <span class="keyword">new</span> <a class="code" href="classOkular_1_1Page.html">Okular::Page</a>( i, size.width(), size.height(), <a class="code" href="namespaceOkular.html#a8556d00465f61ef533c6b027669e7da6aa4df8fc3dd09e30520c264c8d23d89c2">Okular::Rotation0</a> );</div>
<div class="line">      pages[ i ] = page;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> MagicGenerator::doCloseDocument()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> MagicGenerator::canGeneratePixmap()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> MagicGenerator::generatePixmap( <a class="code" href="classOkular_1_1PixmapRequest.html">Okular::PixmapRequest</a> *request )</div>
<div class="line">{</div>
<div class="line">    QImage image = mMagicDocument.pictureOfPage( request-&gt;<a class="code" href="classOkular_1_1PixmapRequest.html#a50f959175182137dbb9e2dbd6ddd71aa">pageNumber</a>() );</div>
<div class="line"></div>
<div class="line">    image = image.scaled( request-&gt;<a class="code" href="classOkular_1_1PixmapRequest.html#a3e82f09b91a52efed7435eeb9903e5fc">width</a>(), request-&gt;<a class="code" href="classOkular_1_1PixmapRequest.html#a782392a2efc6303994c7e0158c76ee06">height</a>(), Qt::IgnoreAspectRatio, Qt::SmoothTransformation );</div>
<div class="line"></div>
<div class="line">    request-&gt;<a class="code" href="classOkular_1_1PixmapRequest.html#a83b5e81f2e908e70f3c19a0a3c07fab3">page</a>()-&gt;<a class="code" href="classOkular_1_1Page.html#ae7e45a6647904b01ebe84930b73f1d79">setPixmap</a>( request-&gt;id(), <span class="keyword">new</span> QPixmap( QPixmap::fromImage( image ) ) );</div>
<div class="line"></div>
<div class="line">    signalPixmapRequestDone( request );</div>
<div class="line">}</div>
</div><!-- fragment --><p>As you can see implementing a basic Generator is quite easy. The loadDocument() method opens the document file and extracts the number of pages. For every page in the document it adds an <a class="el" href="classOkular_1_1Page.html" title="Collector for all the data belonging to a page. ">Okular::Page</a> object to the pages vector which is passed in as method argument. Each page is initialized with its page number, width, height and initial rotation. These page objects will be stored in the document object and act as a container for the picture representation of the pages. This code is the same for nearly every Generator. On an failure the error() signal can be emitted to inform the user about the issue. This code is the same for nearly every Generator.</p>
<p>In the doCloseDocument() method you should close the document and free all resources you have allocated in openDocument().</p>
<p>Now we come to the picture creation methods. The canGeneratorPixmap() method returns whether the Generator is currently able to handle a new pixmap generation request. For a simple Generator like our one that's always the case as it works linear, however a multithreaded Generator might return <em>false</em> here if it is still waiting for one of its working threads to finish. In this case the document class will try to request the pixmap later again.</p>
<p>The generatePixmap() method does the actual fetching of the picture for a page. The page number, requested width and height of the page is encapsulated in the passed <a class="el" href="classOkular_1_1PixmapRequest.html" title="Describes a pixmap type request. ">Okular::PixmapRequest</a> object. So the task of the Generator is to create a pixmap of the requested page in the requested size and then store this pixmap in the <a class="el" href="classOkular_1_1Page.html" title="Collector for all the data belonging to a page. ">Okular::Page</a> object which is associated with the page request. When this task is finished, the Generator has to call signalPixmapRequestDone() with the page request object as argument. This extra call is needed to allow the Generator to use signals and slots internally and create the pixmap asynchronously.</p>
<p>So now you have the code of a working <a class="el" href="namespaceOkular.html">Okular</a> Generator, the next step is to tell <a class="el" href="namespaceOkular.html">Okular</a> about the new plugin. Like in other places in KDE that is done by .desktop files, which are installed to the services directory.</p>
<p>Every Generator needs 3 .desktop files:</p>
<ul>
<li>libokularGenerator_&lt;name&gt;.desktop </li>
<li>okularApplication_&lt;name&gt;.desktop </li>
<li>okular&lt;name&gt;.desktop</li>
</ul>
<p>where &lt;name&gt; should be the name of the document format. So for our Magic Document Generator we create the following 3 files:</p>
<ul>
<li>libokularGenerator_magic.desktop </li>
<li>okularApplication_magic.desktop </li>
<li>okularMagic.desktop</li>
</ul>
<p>with the following content:</p>
<pre class="fragment">[Desktop Entry]
Encoding=UTF-8
Type=Service
Name=Magic Document
Comment=Magic Document backend for okular
ServiceTypes=okular/Generator
MimeType=application/x-magic;
X-KDE-Library=okularGenerator_magic
X-KDE-Priority=1
X-KDE-okularAPIVersion=1
X-KDE-okularHasInternalSettings=false
</pre><p>The first 6 fields are standard .desktop entries, the fields afterwards have a special meaning to <a class="el" href="namespaceOkular.html">Okular</a></p>
<ul>
<li><b>ServiceType</b> Must be 'okular/Generator' for all <a class="el" href="namespaceOkular.html">Okular</a> Generator Plugins </li>
<li><b>MimeType</b> The mimetype or list of mimetypes of the supported document format(s) </li>
<li><b>X-KDE-Library</b> The name of the plugin library </li>
<li><b>X-KDE-Priority</b> When multiple Generators for the same mimetype exists, the one with the highest priority is used </li>
<li><b>X-KDE-okularAPIVersion</b> The version of the Generator Plugin API ('1' currently) </li>
<li><b>X-KDE-okularHasInternalSettings</b> Is 'true' when the Generator provides configuration dialogs</li>
</ul>
<p>The second .desktop file has the following content:</p>
<pre class="fragment">[Desktop Entry]
Encoding=UTF-8
MimeType=application/x-magic;
Terminal=false
Name=okular
GenericName=Document Viewer
Exec=okular %U %i -caption %c
Icon=okular
Type=Application
InitialPreference=7
Categories=Qt;KDE;Graphics;Viewer;
NoDisplay=true
</pre><p>You can use the file as it is, you just have to adapt the mimetype. This file is needed to allow <a class="el" href="namespaceOkular.html">Okular</a> to handle multiple mimetypes.</p>
<p>The third .desktop file looks like this:</p>
<pre class="fragment">[Desktop Entry]
Encoding=UTF-8
Icon=okular
Name=okular
ServiceTypes=KParts/ReadOnlyPart
X-KDE-Library=okularpart
Type=Service
MimeType=application/x-magic;
</pre><p>You can use the file as it is as well, you just have to adapt the mimetype. This file is needed to allow the <a class="el" href="namespaceOkular.html">Okular</a> part to handle multiple mimetypes.</p>
<p>The last piece you need for a complete Generator is a CMakeLists.txt which compiles and installs the Generator. Our CMakeLists.txt looks like the following:</p>
<pre class="fragment">macro_optional_find_package(Okular)

include_directories( ${OKULAR_INCLUDE_DIR} ${KDE4_INCLUDE_DIR} ${QT_INCLUDES} )

########### next target ###############

set( okularGenerator_magic_SRCS generator_magic.cpp )

kde4_add_plugin( okularGenerator_magic ${okularGenerator_magic_SRCS} )

target_link_libraries( okularGenerator_magic ${OKULAR_LIBRARIES} ${KDE4_KDEUI_LIBS} )

install( TARGETS okularGenerator_magic DESTINATION ${PLUGIN_INSTALL_DIR} )

########### install files ###############

install( FILES libokularGenerator_magic.desktop okularMagic.desktop DESTINATION ${SERVICES_INSTALL_DIR} )
install( FILES okularApplication_magic.desktop DESTINATION ${XDG_APPS_INSTALL_DIR} )
</pre><p>The macro_optional_find_package(Okular) call is required to make the ${OKULAR_INCLUDE_DIR} and ${OKULAR_LIBRARIES} variables available.</p>
<p>Now you can compile the Generator plugin and install it. After a restart of <a class="el" href="namespaceOkular.html">Okular</a> the new plugin is available and you can open Magic documents.</p>
<h1><a class="anchor" id="okular_generators_with_text"></a>
A Generator with TextPage support</h1>
<p>In this section we want to extend our Generator to support text search, text extraction and selection as well. As mentioned in <a class="el" href="okular_design.html#okular_design_text_support">Generators with Text support</a>, the Generator must provide an <a class="el" href="classOkular_1_1TextPage.html">Okular::TextPage</a> object for every page which contains readable text.</p>
<p>Since we use the helper class MagicDocument to read the data from the document we have to extend it first, so the new API looks as the following:</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>MagicDocument</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">public</span>:</div>
<div class="line">        MagicDocument();</div>
<div class="line">        ~MagicDocument();</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">bool</span> loadDocument( <span class="keyword">const</span> QString &amp;fileName );</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">int</span> numberOfPages() <span class="keyword">const</span>;</div>
<div class="line"></div>
<div class="line">        QSize <a class="code" href="classpageSize.html">pageSize</a>( <span class="keywordtype">int</span> pageNumber ) <span class="keyword">const</span>;</div>
<div class="line"></div>
<div class="line">        QImage pictureOfPage( <span class="keywordtype">int</span> pageNumber ) <span class="keyword">const</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keyword">class </span>TextInfo</div>
<div class="line">        {</div>
<div class="line">            <span class="keyword">public</span>:</div>
<div class="line">                <span class="keyword">typedef</span> <a class="code" href="classQList.html">QList&lt;TextInfo&gt;</a> List;</div>
<div class="line"></div>
<div class="line">                QChar character;</div>
<div class="line">                qreal xPos;</div>
<div class="line">                qreal yPos;</div>
<div class="line">                qreal width;</div>
<div class="line">                qreal height;</div>
<div class="line">        };</div>
<div class="line"></div>
<div class="line">        TextInfo::List textOfPage( <span class="keywordtype">int</span> pageNumber );</div>
<div class="line"></div>
<div class="line">    <span class="keyword">private</span>:</div>
<div class="line">        ...</div>
<div class="line">};</div>
</div><!-- fragment --><p>MagicDocument has the new internal class TextInfo now, which contains a character and its absolute position on a page. Furthermore MagicDocument provides a method textOfPage() which returns a list of all TextInfo objects for a page.</p>
<p>That's really an optimistic API, in reality it is sometimes quite hard to find out the position of single characters in a document format.</p>
<p>With the extension of our helper class we can continue on extending our Generator now:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;magicdocument.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;okular/core/generator.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>MagicGenerator : <span class="keyword">public</span> <a class="code" href="classOkular_1_1Generator.html">Okular::Generator</a></div>
<div class="line">{</div>
<div class="line">    <span class="keyword">public</span>:</div>
<div class="line">        MagicGenerator( QObject *parent, <span class="keyword">const</span> QVariantList &amp;args );</div>
<div class="line">        ~MagicGenerator();</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">bool</span> <a class="code" href="classOkular_1_1Generator.html#a388b47328a5297d53cdbdc6fcf074ee3">loadDocument</a>( <span class="keyword">const</span> QString &amp;fileName, QVector&lt;Okular::Page*&gt; &amp;pages );</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">bool</span> <a class="code" href="classOkular_1_1Generator.html#abbf00927221e2d2b2b71101f2b7f5732">canGeneratePixmap</a>() <span class="keyword">const</span>;</div>
<div class="line">        <span class="keywordtype">void</span> <a class="code" href="classOkular_1_1Generator.html#a198cdcd9c27b179562c935342fd457b6">generatePixmap</a>( <a class="code" href="classOkular_1_1PixmapRequest.html">Okular::PixmapRequest</a> *request );</div>
<div class="line"></div>
<div class="line">        <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classOkular_1_1Generator.html#a1f41d315daa0d2bd6831e0e7cd48d762">canGenerateTextPage</a>() <span class="keyword">const</span>;</div>
<div class="line">        <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classOkular_1_1Generator.html#a1e2d8c81ac97ec012098c09047d2ddef">generateTextPage</a>( <a class="code" href="classOkular_1_1Page.html">Okular::Page</a> *page, <span class="keyword">enum</span> <a class="code" href="namespaceOkular.html#aefe2f23519d73b489219060219986007">Okular::GenerationType</a> type = <a class="code" href="namespaceOkular.html#aefe2f23519d73b489219060219986007a90d229125a62906242e5b3f5c8923d67">Okular::Synchronous</a> );</div>
<div class="line"></div>
<div class="line">    <span class="keyword">protected</span>:</div>
<div class="line">        <span class="keywordtype">bool</span> <a class="code" href="classOkular_1_1Generator.html#ad3f1dcb98f3bd87c87ad0e91ecf4a6d7">doCloseDocument</a>();</div>
<div class="line"></div>
<div class="line">    <span class="keyword">private</span>:</div>
<div class="line">        MagicDocument mMagicDocument;</div>
<div class="line">};</div>
</div><!-- fragment --><p>We have extended the MagicGenerator class by two methods canGenerateTextPage() and generateTextPage(). The first method is equal to canGeneratePixmap(), it returns whether the Generator is currently able to handle a new text page generation request. For linear Generators that should be always the case, however when the generation is done in a separated worker thread, this method might return <em>false</em>. In this case the document class will try to request the text page later again.</p>
<p>The second method will generate the <a class="el" href="classOkular_1_1TextPage.html">Okular::TextPage</a> object for the passed page. Depending on the capabilities of the Generator and the passed <em>type</em> parameter that is done synchronously or asynchronously.</p>
<p>Let us take a look at the implementation of these methods in our MagicGenerator:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;okular/core/textpage.h&gt;</span></div>
<div class="line"></div>
<div class="line">...</div>
<div class="line"></div>
<div class="line">MagicGenerator::MagicGenerator( QObject *parent, <span class="keyword">const</span> QVariantList &amp;args )</div>
<div class="line">    : <a class="code" href="classOkular_1_1Generator.html">Okular::Generator</a>( parent, args )</div>
<div class="line">{</div>
<div class="line">    setFeature( TextExtraction );</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> MagicGenerator::canGenerateTextPage()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> MagicGenerator::generateTextPage( <a class="code" href="classOkular_1_1Page.html">Okular::Page</a> *page, <span class="keyword">enum</span> <a class="code" href="namespaceOkular.html#aefe2f23519d73b489219060219986007">Okular::GenerationType</a> )</div>
<div class="line">{</div>
<div class="line">    MagicDocument::TextInfo::List characters = mMagicDocument.textOfPage( page-&gt;<a class="code" href="classOkular_1_1Page.html#a6eee5f157a130b47d81ddd63e501664b">number</a>() );</div>
<div class="line">    <span class="keywordflow">if</span> ( characters.isEmpty() )</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classOkular_1_1TextPage.html">Okular::TextPage</a> *textPage = <span class="keyword">new</span> <a class="code" href="classOkular_1_1TextPage.html">Okular::TextPage</a>;</div>
<div class="line">    <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; characters.count(); ++i ) {</div>
<div class="line">        qreal left = characters[ i ].xPos / page-&gt;<a class="code" href="classOkular_1_1Page.html#a57114e88281da2a51b1bb0d5d4996d53">width</a>();</div>
<div class="line">        qreal top = characters[ i ].yPos / page-&gt;<a class="code" href="classOkular_1_1Page.html#a67246a32b3e625946eb5c685b8372a4f">height</a>();</div>
<div class="line">        qreal right = (characters[ i ].xPos + characters[ i ].width) / page-&gt;<a class="code" href="classOkular_1_1Page.html#a57114e88281da2a51b1bb0d5d4996d53">width</a>();</div>
<div class="line">        qreal bottom = (characters[ i ].yPos + characters[ i ].height) / page-&gt;<a class="code" href="classOkular_1_1Page.html#a67246a32b3e625946eb5c685b8372a4f">height</a>();</div>
<div class="line"></div>
<div class="line">        textPage-&gt;<a class="code" href="classOkular_1_1TextPage.html#a003032e4e1cd8c15f01ed639ce62d11f">append</a>( characters[ i ].character,</div>
<div class="line">                          <span class="keyword">new</span> <a class="code" href="classOkular_1_1NormalizedRect.html">Okular::NormalizedRect</a>( left, top, right, bottom ) );</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    page-&gt;<a class="code" href="classOkular_1_1Page.html#a2853c6369aa8ebe6b0593201ce9cf49e">setTextPage</a>( textPage );</div>
<div class="line">}</div>
</div><!-- fragment --><p>As you can see the generateTextPage method just iterates over the list of characters returned by our MagicDocument helper class and adds the character and its normalized bounding rect to the <a class="el" href="classOkular_1_1TextPage.html">Okular::TextPage</a> object. At the end the text page is assigned to the page. We don't pay attention to the GenerationType parameter here, if your Generator want to use threads, it should check here whether the request shall be done asynchronously or synchronously and start the generation according to that. Additionally we have to tell the <a class="el" href="classOkular_1_1Generator.html" title="[Abstract Class] The information generator. ">Okular::Generator</a> base class that we support text handling by setting this flag in the constructor.</p>
<p>In this state we can now search, select and extract text from Magic documents.</p>
<h1><a class="anchor" id="okular_generators_threaded"></a>
A Generator with Thread support</h1>
<p>Sometimes it makes sense to do the generation of page pictures or text pages asynchronously to improve performance and don't blocking the user interface. This can be done in two ways, either by using signals and slots or by using threads. Both have there pros and cons:</p>
<ul>
<li>
<b>Signals and Slots</b> <ul>
<li>
Pro: Can be used with backend libraries which are not thread safe </li>
<li>
Con: Sometime difficult to implement </li>
</ul>
</li>
<li>
<b>Threads</b> <ul>
<li>
Pro: Easy to implement as you can make synchronous calls to the backend libraries </li>
<li>
Con: Backend libraries must be thread safe and you must prevent race conditions by using mutexes </li>
</ul>
</li>
</ul>
<p>The signal and slots approach can be achieved with a normal Generator by calling <a class="el" href="classOkular_1_1Generator.html#abed0ea73d02be9c4a0afcd920882faf5">Okular::Generator::signalPixmapRequestDone()</a> from a slot after pixmap generation has been finished.</p>
<p>When using threads you should use a slightly different API, which hides most of the thread usage, to make implementing as easy as possible.</p>
<p>Let's assume the pictureOfPage() and textOfPage methods in our MagicDocument helper class are thread safe, so we can use them in a multithreaded environment. So nothing prevents us from changing the MagicGenerator to use threads for better performance.</p>
<p>The new MagicGenerator API looks like the following:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;magicdocument.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;okular/core/generator.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>MagicGenerator : <span class="keyword">public</span> <a class="code" href="classOkular_1_1Generator.html">Okular::Generator</a></div>
<div class="line">{</div>
<div class="line">    <span class="keyword">public</span>:</div>
<div class="line">        MagicGenerator( QObject *parent, <span class="keyword">const</span> QVariantList &amp;args );</div>
<div class="line">        ~MagicGenerator();</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">bool</span> <a class="code" href="classOkular_1_1Generator.html#a388b47328a5297d53cdbdc6fcf074ee3">loadDocument</a>( <span class="keyword">const</span> QString &amp;fileName, QVector&lt;Okular::Page*&gt; &amp;pages );</div>
<div class="line"></div>
<div class="line">    <span class="keyword">protected</span>:</div>
<div class="line">        <span class="keywordtype">bool</span> <a class="code" href="classOkular_1_1Generator.html#ad3f1dcb98f3bd87c87ad0e91ecf4a6d7">doCloseDocument</a>();</div>
<div class="line"></div>
<div class="line">        <span class="keyword">virtual</span> QImage <a class="code" href="classOkular_1_1Generator.html#a6712c8d3c2759c3a1fcacbd503d3286e">image</a>( <a class="code" href="classOkular_1_1PixmapRequest.html">Okular::PixmapRequest</a> *request );</div>
<div class="line"></div>
<div class="line">        <span class="keyword">virtual</span> <a class="code" href="classOkular_1_1TextPage.html">Okular::TextPage</a>* <a class="code" href="classOkular_1_1Generator.html#af7915b97ab4b9347fb76babdda212cef">textPage</a>( <a class="code" href="classOkular_1_1Page.html">Okular::Page</a> *page );</div>
<div class="line"></div>
<div class="line">    <span class="keyword">private</span>:</div>
<div class="line">        MagicDocument mMagicDocument;</div>
<div class="line">};</div>
</div><!-- fragment --><p>As you can see the canGeneratePixmap() generatePixmap(), canGenerateTextPage() and generateTextPage() methods have been removed and replaced by the image() and textPage() methods.</p>
<p>Before explaining why, we'll take a look at the implementation:</p>
<div class="fragment"><div class="line">MagicGenerator::MagicGenerator( QObject *parent, <span class="keyword">const</span> QVariantList &amp;args )</div>
<div class="line">    : Okular::Generator( parent, args )</div>
<div class="line">{</div>
<div class="line">    setFeature( TextExtraction );</div>
<div class="line">    setFeature( Threaded );</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">QImage MagicGenerator::image( <a class="code" href="classOkular_1_1PixmapRequest.html">Okular::PixmapRequest</a> *request )</div>
<div class="line">{</div>
<div class="line">    QImage image = mMagicDocument.pictureOfPage( request-&gt;<a class="code" href="classOkular_1_1PixmapRequest.html#a50f959175182137dbb9e2dbd6ddd71aa">pageNumber</a>() );</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> image.scaled( request-&gt;<a class="code" href="classOkular_1_1PixmapRequest.html#a3e82f09b91a52efed7435eeb9903e5fc">width</a>(), request-&gt;<a class="code" href="classOkular_1_1PixmapRequest.html#a782392a2efc6303994c7e0158c76ee06">height</a>(), Qt::IgnoreAspectRatio, Qt::SmoothTransformation );</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><a class="code" href="classOkular_1_1TextPage.html">Okular::TextPage</a>* textPage( <a class="code" href="classOkular_1_1Page.html">Okular::Page</a> *page )</div>
<div class="line">{</div>
<div class="line">    MagicDocument::TextInfo::List characters = mMagicDocument.textOfPage( page-&gt;<a class="code" href="classOkular_1_1Page.html#a6eee5f157a130b47d81ddd63e501664b">number</a>() );</div>
<div class="line">    <span class="keywordflow">if</span> ( characters.isEmpty() )</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classOkular_1_1TextPage.html">Okular::TextPage</a> *textPage = <span class="keyword">new</span> <a class="code" href="classOkular_1_1TextPage.html">Okular::TextPage</a>;</div>
<div class="line">    <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; characters.count(); ++i ) {</div>
<div class="line">        qreal left = characters[ i ].xPos / page-&gt;<a class="code" href="classOkular_1_1Page.html#a57114e88281da2a51b1bb0d5d4996d53">width</a>();</div>
<div class="line">        qreal top = characters[ i ].yPos / page-&gt;<a class="code" href="classOkular_1_1Page.html#a67246a32b3e625946eb5c685b8372a4f">height</a>();</div>
<div class="line">        qreal right = (characters[ i ].xPos + characters[ i ].width) / page-&gt;<a class="code" href="classOkular_1_1Page.html#a57114e88281da2a51b1bb0d5d4996d53">width</a>();</div>
<div class="line">        qreal bottom = (characters[ i ].yPos + characters[ i ].height) / page-&gt;<a class="code" href="classOkular_1_1Page.html#a67246a32b3e625946eb5c685b8372a4f">height</a>();</div>
<div class="line"></div>
<div class="line">        textPage-&gt;<a class="code" href="classOkular_1_1TextPage.html#a003032e4e1cd8c15f01ed639ce62d11f">append</a>( characters[ i ].character,</div>
<div class="line">                          <span class="keyword">new</span> <a class="code" href="classOkular_1_1NormalizedRect.html">Okular::NormalizedRect</a>( left, top, right, bottom ) );</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> textPage;</div>
<div class="line">}</div>
</div><!-- fragment --><p>So the first obviously thing is that both methods return a value instead of modifying the page directly. The reason for this is that both methods are executed in its own thread, so the code executed in them can block as long as it wants, it won't block the GUI anyway. Additionally we have to tell the <a class="el" href="classOkular_1_1Generator.html" title="[Abstract Class] The information generator. ">Okular::Generator</a> base class that we can handle threads by setting the flag in the constructor.</p>
<p>With only a small change we made our MagicGenerator multithreaded now!</p>
<h1><a class="anchor" id="okular_generators_extended"></a>
An Extended Generator</h1>
<p>Now we want to create a new generator with some additional functionality:</p>
<ul>
<li>Support for document information (author, creation date etc.) </li>
<li>Support for a table of content </li>
<li>Support for printing the document </li>
<li>Support for exporting the document as text</li>
</ul>
<p>The new Generator shall be able to handle HTML documents. We choose this format as example, because we can use QTextDocument to load, render and print a HTML page, so a lot of code can be reused.</p>
<p>The API of our HTMLGenerator looks like the following:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;QtGui/QTextDocument&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;okular/core/generator.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>HTMLGenerator : <span class="keyword">public</span> <a class="code" href="classOkular_1_1Generator.html">Okular::Generator</a></div>
<div class="line">{</div>
<div class="line">    <span class="keyword">public</span>:</div>
<div class="line">        HTMLGenerator( QObject *parent, <span class="keyword">const</span> QVariantList &amp;args );</div>
<div class="line">        ~HTMLGenerator();</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">bool</span> <a class="code" href="classOkular_1_1Generator.html#a388b47328a5297d53cdbdc6fcf074ee3">loadDocument</a>( <span class="keyword">const</span> QString &amp;fileName, QVector&lt;Okular::Page*&gt; &amp;pages );</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">bool</span> <a class="code" href="classOkular_1_1Generator.html#abbf00927221e2d2b2b71101f2b7f5732">canGeneratePixmap</a>() <span class="keyword">const</span>;</div>
<div class="line">        <span class="keywordtype">void</span> <a class="code" href="classOkular_1_1Generator.html#a198cdcd9c27b179562c935342fd457b6">generatePixmap</a>( <a class="code" href="classOkular_1_1PixmapRequest.html">Okular::PixmapRequest</a> *request );</div>
<div class="line"></div>
<div class="line">        <span class="keyword">virtual</span> <span class="keyword">const</span> <a class="code" href="classOkular_1_1DocumentInfo.html">Okular::DocumentInfo</a>* <a class="code" href="classOkular_1_1Generator.html#a9993dd0a2415499e23d8394e7a447e98">generateDocumentInfo</a>();</div>
<div class="line"></div>
<div class="line">        <span class="keyword">virtual</span> <span class="keyword">const</span> <a class="code" href="classOkular_1_1DocumentSynopsis.html">Okular::DocumentSynopsis</a>* <a class="code" href="classOkular_1_1Generator.html#a1f8b31c19d7a5101cadf3fe3186ab0f1">generateDocumentSynopsis</a>();</div>
<div class="line"></div>
<div class="line">        <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classOkular_1_1Generator.html#aa786d406a1b0db6679a3bc62bbe2dc82">print</a>( KPrinter &amp;printer );</div>
<div class="line"></div>
<div class="line">        <span class="keyword">virtual</span> <a class="code" href="classQList.html">Okular::ExportFormat::List</a> <a class="code" href="classOkular_1_1Generator.html#a74280fb193319daab955feac694123ac">exportFormats</a>() <span class="keyword">const</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classOkular_1_1Generator.html#a9e78f37aafbfdaf04f76f4163c27aa5e">exportTo</a>( <span class="keyword">const</span> QString &amp;fileName, <span class="keyword">const</span> <a class="code" href="classOkular_1_1ExportFormat.html">Okular::ExportFormat</a> &amp;format );</div>
<div class="line"></div>
<div class="line">    <span class="keyword">protected</span>:</div>
<div class="line">        <span class="keywordtype">bool</span> <a class="code" href="classOkular_1_1Generator.html#ad3f1dcb98f3bd87c87ad0e91ecf4a6d7">doCloseDocument</a>();</div>
<div class="line"></div>
<div class="line">    <span class="keyword">private</span>:</div>
<div class="line">        QTextDocument *mTextDocument;</div>
<div class="line">        <a class="code" href="classOkular_1_1DocumentInfo.html">Okular::DocumentInfo</a> mDocumentInfo;</div>
<div class="line">        <a class="code" href="classOkular_1_1DocumentSynopsis.html">Okular::DocumentSynopsis</a> mDocumentSynopsis;</div>
<div class="line">};</div>
</div><!-- fragment --><p>The Generator doesn't support text search and selection, as the code would be quite complex, we'll show how to do it in the next chapter okular_generators_textdocument anyway.</p>
<p>As you can see we have 5 new methods in the class:</p>
<ul>
<li><b>generateDocumentInfo()</b> Creates an <a class="el" href="classOkular_1_1DocumentInfo.html" title="A DOM tree containing information about the document. ">Okular::DocumentInfo</a> (which is infact a QDomDocument) which contains document information like author, creation time etc. </li>
<li><b>generateDocumentSynopsis()</b> Creates an <a class="el" href="classOkular_1_1DocumentSynopsis.html" title="A DOM tree that describes the Table of Contents. ">Okular::DocumentSynopsis</a> (which is a QDomDocument as well) which contains the table of content. </li>
<li><b>print()</b> Prints the document to the passed printer. </li>
<li><b>exportFormats()</b> Returns the supported export formats. </li>
<li><b>exportTo()</b> Exports the document to the given file in the given format.</li>
</ul>
<p>Now that you know what the methods are supposed to do, let's take a look at the implementation:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;QtCore/QFile&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;QtGui/QAbstractTextDocumentLayout&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;kprinter.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;okular/core/document.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;okular/core/page.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;htmlgenerator.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> KAboutData createAboutData()</div>
<div class="line">{</div>
<div class="line">    KAboutData aboutData(...);</div>
<div class="line">    <span class="comment">// fill the about data</span></div>
<div class="line">    <span class="keywordflow">return</span> aboutData;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><a class="code" href="generator_8h.html#a87d954a3809f78e33fb1cb8e2369a05c">OKULAR_EXPORT_PLUGIN</a>(HTMLGenerator, createAboutData())</div>
<div class="line"></div>
<div class="line">HTMLGenerator::HTMLGenerator( QObject *parent, const QVariantList &amp;args )</div>
<div class="line">    : Okular::Generator( parent, args ),</div>
<div class="line">      mTextDocument( 0 )</div>
<div class="line">{</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">HTMLGenerator::~HTMLGenerator()</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">delete</span> mTextDocument;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> HTMLGenerator::loadDocument( <span class="keyword">const</span> QString &amp;fileName, QVector&lt;Okular::Page*&gt; &amp;pages )</div>
<div class="line">{</div>
<div class="line">    QFile file( fileName );</div>
<div class="line">    <span class="keywordflow">if</span> ( !file.open( QIODevice::ReadOnly ) ) {</div>
<div class="line">        emit error( i18n( <span class="stringliteral">&quot;Unable to open file&quot;</span> ), -1 );</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> QString data = QString::fromUtf8( file.readAll() );</div>
<div class="line"></div>
<div class="line">    file.close();</div>
<div class="line"></div>
<div class="line">    mTextDocument = <span class="keyword">new</span> QTextDocument;</div>
<div class="line">    mTextDocument-&gt;setHtml( data );</div>
<div class="line">    mTextDocument-&gt;setPageSize( QSizeF( 600, 800 ) );</div>
<div class="line"></div>
<div class="line">    pages.resize( mTextDocument-&gt;pageCount() );</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; mTextDocument-&gt;pageCount(); ++i ) {</div>
<div class="line">      <a class="code" href="classOkular_1_1Page.html">Okular::Page</a> * page = <span class="keyword">new</span> <a class="code" href="classOkular_1_1Page.html">Okular::Page</a>( i, 600, 800, <a class="code" href="namespaceOkular.html#a8556d00465f61ef533c6b027669e7da6aa4df8fc3dd09e30520c264c8d23d89c2">Okular::Rotation0</a> );</div>
<div class="line">      pages[ i ] = page;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    mDocumentInfo.set( <span class="stringliteral">&quot;author&quot;</span>, <span class="stringliteral">&quot;Tobias Koenig&quot;</span>, i18n( <span class="stringliteral">&quot;Author&quot;</span> ) );</div>
<div class="line">    mDocumentInfo.set( <span class="stringliteral">&quot;title&quot;</span>, <span class="stringliteral">&quot;The Art of Okular Plugin Development&quot;</span>, i18n( <span class="stringliteral">&quot;Title&quot;</span> ) );</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classOkular_1_1DocumentViewport.html">Okular::DocumentViewport</a> viewport = ... <span class="comment">// get the viewport of the chapter</span></div>
<div class="line"></div>
<div class="line">    QDomElement item = mDocumentSynopsis.createElement( <span class="stringliteral">&quot;Chapter 1&quot;</span> );</div>
<div class="line">    item.setAttribute( <span class="stringliteral">&quot;Viewport&quot;</span>, viewport.<a class="code" href="classOkular_1_1DocumentViewport.html#a77e42e0c9502b91085cd25f845ecafa0">toString</a>() );</div>
<div class="line">    mDocumentSynopsis.appendChild( item );</div>
<div class="line"></div>
<div class="line">    viewport = ... <span class="comment">// get the viewport of the subchapter</span></div>
<div class="line"></div>
<div class="line">    QDomElement childItem = mDocumentSynopsis.createElement( <span class="stringliteral">&quot;SubChapter 1.1&quot;</span> );</div>
<div class="line">    childItem.setAttribute( <span class="stringliteral">&quot;Viewport&quot;</span>, viewport.<a class="code" href="classOkular_1_1DocumentViewport.html#a77e42e0c9502b91085cd25f845ecafa0">toString</a>() );</div>
<div class="line">    item.appendChild( childItem );</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> HTMLGenerator::doCloseDocument()</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">delete</span> mTextDocument;</div>
<div class="line">    mTextDocument = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> HTMLGenerator::canGeneratePixmap()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> HTMLGenerator::generatePixmap( <a class="code" href="classOkular_1_1PixmapRequest.html">Okular::PixmapRequest</a> *request )</div>
<div class="line">{</div>
<div class="line">    QPixmap *pixmap = <span class="keyword">new</span> QPixmap( request-&gt;<a class="code" href="classOkular_1_1PixmapRequest.html#a3e82f09b91a52efed7435eeb9903e5fc">width</a>(), request-&gt;<a class="code" href="classOkular_1_1PixmapRequest.html#a782392a2efc6303994c7e0158c76ee06">height</a>() );</div>
<div class="line">    pixmap-&gt;fill( Qt::white );</div>
<div class="line"></div>
<div class="line">    QPainter p;</div>
<div class="line">    p.begin( pixmap );</div>
<div class="line"></div>
<div class="line">    qreal width = request-&gt;<a class="code" href="classOkular_1_1PixmapRequest.html#a3e82f09b91a52efed7435eeb9903e5fc">width</a>();</div>
<div class="line">    qreal height = request-&gt;<a class="code" href="classOkular_1_1PixmapRequest.html#a782392a2efc6303994c7e0158c76ee06">height</a>();</div>
<div class="line"></div>
<div class="line">    p.scale( width / 600, height / 800 );</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> QRect rect( 0, request-&gt;<a class="code" href="classOkular_1_1PixmapRequest.html#a50f959175182137dbb9e2dbd6ddd71aa">pageNumber</a>() * 800, 600, 800 );</div>
<div class="line">    p.translate( QPoint( 0, request-&gt;<a class="code" href="classOkular_1_1PixmapRequest.html#a50f959175182137dbb9e2dbd6ddd71aa">pageNumber</a>() * -800 ) );</div>
<div class="line">    d-&gt;mDocument-&gt;drawContents( &amp;p, rect );</div>
<div class="line">    p.end();</div>
<div class="line"></div>
<div class="line">    request-&gt;<a class="code" href="classOkular_1_1PixmapRequest.html#a83b5e81f2e908e70f3c19a0a3c07fab3">page</a>()-&gt;<a class="code" href="classOkular_1_1Page.html#ae7e45a6647904b01ebe84930b73f1d79">setPixmap</a>( request-&gt;id(), pixmap );</div>
<div class="line"></div>
<div class="line">    signalPixmapRequestDone( request );</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">const</span> <a class="code" href="classOkular_1_1DocumentInfo.html">Okular::DocumentInfo</a>* HTMLGenerator::generateDocumentInfo()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> &amp;mDocumentInfo;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">const</span> <a class="code" href="classOkular_1_1DocumentSynopsis.html">Okular::DocumentSynopsis</a>* HTMLGenerator::generateDocumentSynopsis()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> ( !mDocumentSynopsis.hasChildNodes() )</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        <span class="keywordflow">return</span> &amp;mDocumentSynopsis;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> HTMLGenerator::print( KPrinter &amp;printer )</div>
<div class="line">{</div>
<div class="line">    QPainter p( &amp;printer );</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; mTextDocument-&gt;pageCount(); ++i ) {</div>
<div class="line">        <span class="keywordflow">if</span> ( i != 0 )</div>
<div class="line">            printer.newPage();</div>
<div class="line"></div>
<div class="line">        QRect rect( 0, i * 800, 600, 800 );</div>
<div class="line">        p.translate( QPoint( 0, i * -800 ) );</div>
<div class="line">        mTextDocument-&gt;drawContents( &amp;p, rect );</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><a class="code" href="classQList.html">Okular::ExportFormat::List</a> HTMLGenerator::exportFormats()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="classOkular_1_1ExportFormat.html#a5a403d349fe023513836471a18f55ced">Okular::ExportFormat::standardFormat</a>( <a class="code" href="classOkular_1_1ExportFormat.html#af030ecc6c77b5cdd89cd1bc4a894c6f2ad7daf23a3915d800df9de1b417a4b65a">Okular::ExportFormat::PlainText</a> );</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> HTMLGenerator::exportTo( <span class="keyword">const</span> QString &amp;fileName, <span class="keyword">const</span> <a class="code" href="classOkular_1_1ExportFormat.html">Okular::ExportFormat</a> &amp;format )</div>
<div class="line">{</div>
<div class="line">    QFile file( fileName );</div>
<div class="line">    <span class="keywordflow">if</span> ( !fileName.open( QIODevice::WriteOnly ) ) {</div>
<div class="line">        emit error( i18n( <span class="stringliteral">&quot;Unable to open file&quot;</span> ), -1 );</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ( format.<a class="code" href="classOkular_1_1ExportFormat.html#ab37ac9aa0c65cdff5e9666e1390d79de">mimeType</a>()-&gt;name() == QLatin1String( <span class="stringliteral">&quot;text/plain&quot;</span> ) )</div>
<div class="line">        file.writeBlock( mTextDocument-&gt;toPlainText().toUtf8() );</div>
<div class="line"></div>
<div class="line">    file.close();</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Let's take a closer look at the single methods. In the loadDocument() method we try to open the passed file name and read all the content into the QTextDocument object. By calling QTextDocument::setPageSize(), the whole document is divided into pages of the given size. In the next step we create <a class="el" href="classOkular_1_1Page.html" title="Collector for all the data belonging to a page. ">Okular::Page</a> objects for every page in the QTextDocument and fill the pages vector with them.</p>
<p>Afterwards we fill our <a class="el" href="classOkular_1_1DocumentInfo.html" title="A DOM tree containing information about the document. ">Okular::DocumentInfo</a> object with data. Since extracting the HTML meta data would need a lot of code we work with static data here. [to be continued] </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue Apr 15 2014 21:15:59 for GP&#39;s Okular Build by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
