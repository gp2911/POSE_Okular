\hypertarget{classPagePainter}{\section{Page\+Painter Class Reference}
\label{classPagePainter}\index{Page\+Painter@{Page\+Painter}}
}


Paints a \hyperlink{classOkular_1_1Page}{Okular\+::\+Page} to an open painter using given flags.  




{\ttfamily \#include $<$pagepainter.\+h$>$}

\subsection*{Public Types}
\begin{DoxyCompactItemize}
\item 
enum \hyperlink{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01}{Page\+Painter\+Flags} \{ \\*
\hyperlink{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01ac3c6879723c19935fb6fe250d0feca17}{Accessibility} = 1, 
\hyperlink{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01a388b8bc0e65542c5b36324ed9331b982}{Enhance\+Links} = 2, 
\hyperlink{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01acbf8b61fc5bea59ff83332b5219a8ed2}{Enhance\+Images} = 4, 
\hyperlink{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01a3582deaa27eb857b1bbdd54e6174b3b5}{Highlights} = 8, 
\\*
\hyperlink{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01a76eae803a84abe4cdf3c21b73c2d266d}{Text\+Selection} = 16, 
\hyperlink{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01a87c63f97188bb13cbafd5ae63be3fe40}{Annotations} = 32
 \}
\end{DoxyCompactItemize}
\subsection*{Static Public Member Functions}
\begin{DoxyCompactItemize}
\item 
static void \hyperlink{classPagePainter_a5eea3c770160bf6b62f36ef802b5bd25}{paint\+Page\+On\+Painter} (Q\+Painter $\ast$p, const \hyperlink{classOkular_1_1Page}{Okular\+::\+Page} $\ast$page, \hyperlink{classOkular_1_1DocumentObserver}{Okular\+::\+Document\+Observer} $\ast$observer, int flags, int scaled\+Width, int scaled\+Height, const Q\+Rect \&page\+Limits)
\item 
static void \hyperlink{classPagePainter_af6d636a41a9b1ebe8954c53bf5e3e6ec}{paint\+Cropped\+Page\+On\+Painter} (Q\+Painter $\ast$p, const \hyperlink{classOkular_1_1Page}{Okular\+::\+Page} $\ast$page, \hyperlink{classOkular_1_1DocumentObserver}{Okular\+::\+Document\+Observer} $\ast$observer, int flags, int scaled\+Width, int scaled\+Height, const Q\+Rect \&page\+Limits, const \hyperlink{classOkular_1_1NormalizedRect}{Okular\+::\+Normalized\+Rect} \&crop, \hyperlink{classOkular_1_1NormalizedPoint}{Okular\+::\+Normalized\+Point} $\ast$view\+Port\+Point)
\end{DoxyCompactItemize}


\subsection{Detailed Description}
Paints a \hyperlink{classOkular_1_1Page}{Okular\+::\+Page} to an open painter using given flags. 

Definition at line 29 of file pagepainter.\+h.



\subsection{Member Enumeration Documentation}
\hypertarget{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01}{\index{Page\+Painter@{Page\+Painter}!Page\+Painter\+Flags@{Page\+Painter\+Flags}}
\index{Page\+Painter\+Flags@{Page\+Painter\+Flags}!Page\+Painter@{Page\+Painter}}
\subsubsection[{Page\+Painter\+Flags}]{\setlength{\rightskip}{0pt plus 5cm}enum {\bf Page\+Painter\+::\+Page\+Painter\+Flags}}}\label{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01}
\begin{Desc}
\item[Enumerator]\par
\begin{description}
\index{Accessibility@{Accessibility}!Page\+Painter@{Page\+Painter}}\index{Page\+Painter@{Page\+Painter}!Accessibility@{Accessibility}}\item[{\em 
\hypertarget{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01ac3c6879723c19935fb6fe250d0feca17}{Accessibility}\label{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01ac3c6879723c19935fb6fe250d0feca17}
}]\index{Enhance\+Links@{Enhance\+Links}!Page\+Painter@{Page\+Painter}}\index{Page\+Painter@{Page\+Painter}!Enhance\+Links@{Enhance\+Links}}\item[{\em 
\hypertarget{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01a388b8bc0e65542c5b36324ed9331b982}{Enhance\+Links}\label{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01a388b8bc0e65542c5b36324ed9331b982}
}]\index{Enhance\+Images@{Enhance\+Images}!Page\+Painter@{Page\+Painter}}\index{Page\+Painter@{Page\+Painter}!Enhance\+Images@{Enhance\+Images}}\item[{\em 
\hypertarget{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01acbf8b61fc5bea59ff83332b5219a8ed2}{Enhance\+Images}\label{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01acbf8b61fc5bea59ff83332b5219a8ed2}
}]\index{Highlights@{Highlights}!Page\+Painter@{Page\+Painter}}\index{Page\+Painter@{Page\+Painter}!Highlights@{Highlights}}\item[{\em 
\hypertarget{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01a3582deaa27eb857b1bbdd54e6174b3b5}{Highlights}\label{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01a3582deaa27eb857b1bbdd54e6174b3b5}
}]\index{Text\+Selection@{Text\+Selection}!Page\+Painter@{Page\+Painter}}\index{Page\+Painter@{Page\+Painter}!Text\+Selection@{Text\+Selection}}\item[{\em 
\hypertarget{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01a76eae803a84abe4cdf3c21b73c2d266d}{Text\+Selection}\label{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01a76eae803a84abe4cdf3c21b73c2d266d}
}]\index{Annotations@{Annotations}!Page\+Painter@{Page\+Painter}}\index{Page\+Painter@{Page\+Painter}!Annotations@{Annotations}}\item[{\em 
\hypertarget{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01a87c63f97188bb13cbafd5ae63be3fe40}{Annotations}\label{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01a87c63f97188bb13cbafd5ae63be3fe40}
}]\end{description}
\end{Desc}


Definition at line 34 of file pagepainter.\+h.


\begin{DoxyCode}
34                               \{ \hyperlink{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01ac3c6879723c19935fb6fe250d0feca17}{Accessibility} = 1, \hyperlink{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01a388b8bc0e65542c5b36324ed9331b982}{EnhanceLinks} = 2,
35                                 \hyperlink{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01acbf8b61fc5bea59ff83332b5219a8ed2}{EnhanceImages} = 4, \hyperlink{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01a3582deaa27eb857b1bbdd54e6174b3b5}{Highlights} = 8,
36                                 \hyperlink{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01a76eae803a84abe4cdf3c21b73c2d266d}{TextSelection} = 16, \hyperlink{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01a87c63f97188bb13cbafd5ae63be3fe40}{Annotations} = 32 \};
\end{DoxyCode}


\subsection{Member Function Documentation}
\hypertarget{classPagePainter_af6d636a41a9b1ebe8954c53bf5e3e6ec}{\index{Page\+Painter@{Page\+Painter}!paint\+Cropped\+Page\+On\+Painter@{paint\+Cropped\+Page\+On\+Painter}}
\index{paint\+Cropped\+Page\+On\+Painter@{paint\+Cropped\+Page\+On\+Painter}!Page\+Painter@{Page\+Painter}}
\subsubsection[{paint\+Cropped\+Page\+On\+Painter}]{\setlength{\rightskip}{0pt plus 5cm}void Page\+Painter\+::paint\+Cropped\+Page\+On\+Painter (
\begin{DoxyParamCaption}
\item[{Q\+Painter $\ast$}]{p, }
\item[{const {\bf Okular\+::\+Page} $\ast$}]{page, }
\item[{{\bf Okular\+::\+Document\+Observer} $\ast$}]{observer, }
\item[{int}]{flags, }
\item[{int}]{scaled\+Width, }
\item[{int}]{scaled\+Height, }
\item[{const Q\+Rect \&}]{page\+Limits, }
\item[{const {\bf Okular\+::\+Normalized\+Rect} \&}]{crop, }
\item[{{\bf Okular\+::\+Normalized\+Point} $\ast$}]{view\+Port\+Point}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{classPagePainter_af6d636a41a9b1ebe8954c53bf5e3e6ec}
1 -\/ R\+E\+T\+R\+I\+E\+V\+E T\+H\+E 'P\+A\+G\+E+\+I\+D' P\+I\+X\+M\+A\+P O\+R A S\+I\+M\+I\+L\+A\+R 'P\+A\+G\+E' O\+N\+E

1\+B -\/ I\+F N\+O P\+I\+X\+M\+A\+P, D\+R\+A\+W E\+M\+P\+T\+Y P\+A\+G\+E

2 -\/ F\+I\+N\+D O\+U\+T W\+H\+A\+T T\+O P\+A\+I\+N\+T (Flags + Configuration + Presence)

3 -\/ E\+N\+A\+B\+L\+E B\+A\+C\+K\+B\+U\+F\+F\+E\+R\+I\+N\+G I\+F D\+I\+R\+E\+C\+T I\+M\+A\+G\+E M\+A\+N\+I\+P\+U\+L\+A\+T\+I\+O\+N I\+S N\+E\+E\+D\+E\+D

4\+A -- R\+E\+G\+U\+L\+A\+R F\+L\+O\+W. P\+A\+I\+N\+T P\+I\+X\+M\+A\+P N\+O\+R\+M\+A\+L O\+R R\+E\+S\+C\+A\+L\+E\+D U\+S\+I\+N\+G G\+I\+V\+E\+N Q\+P\+A\+I\+N\+T\+E\+R

4\+B -- B\+U\+F\+F\+E\+R\+E\+D F\+L\+O\+W. I\+M\+A\+G\+E P\+A\+I\+N\+T\+I\+N\+G + O\+P\+E\+R\+A\+T\+I\+O\+N\+S. Q\+P\+A\+I\+N\+T\+E\+R O\+V\+E\+R P\+I\+X\+M\+A\+P

5 -- M\+I\+X\+E\+D F\+L\+O\+W. Draw A\+N\+N\+O\+T\+A\+T\+I\+O\+N\+S \mbox{[}O\+P\+A\+Q\+U\+E O\+N\+E\+S\mbox{]} on A\+C\+T\+I\+V\+E P\+A\+I\+N\+T\+E\+R

6 -- M\+I\+X\+E\+D F\+L\+O\+W. Draw L\+I\+N\+K\+S+\+I\+M\+A\+G\+E\+S B\+O\+R\+D\+E\+R on A\+C\+T\+I\+V\+E P\+A\+I\+N\+T\+E\+R

7 -- B\+U\+F\+F\+E\+R\+E\+D F\+L\+O\+W. Copy B\+A\+C\+K\+P\+I\+X\+M\+A\+P on D\+E\+S\+T\+I\+N\+A\+T\+I\+O\+N P\+A\+I\+N\+T\+E\+R 

Definition at line 62 of file pagepainter.\+cpp.


\begin{DoxyCode}
65 \{
66     \textcolor{comment}{/* Calculate the cropped geometry of the page */}
67     QRect scaledCrop = crop.\hyperlink{classOkular_1_1NormalizedRect_a006897c5fcff2c3a97b4141f1a967513}{geometry}( scaledWidth, scaledHeight );
68     \textcolor{keywordtype}{int} croppedWidth = scaledCrop.width();
69     \textcolor{keywordtype}{int} croppedHeight = scaledCrop.height();
70 
71     QColor paperColor = Qt::white;
72     QColor backgroundColor = paperColor;
73     \textcolor{keywordflow}{if} ( \hyperlink{classOkular_1_1SettingsCore_af01449e331a4e973d5cb3879a3e76081}{Okular::SettingsCore::changeColors}() )
74     \{
75         \textcolor{keywordflow}{switch} ( \hyperlink{classOkular_1_1SettingsCore_a6fcb9ee5ad7a92b49ad31344771cca2d}{Okular::SettingsCore::renderMode}() )
76         \{
77             \textcolor{keywordflow}{case} \hyperlink{classOkular_1_1SettingsCore_1_1EnumRenderMode_aae172bdb345dda4d639e763709ea357aae3a52d8c06b668f28a3f3d646c49d3b0}{Okular::SettingsCore::EnumRenderMode::Inverted}
      :
78                 backgroundColor = Qt::black;
79                 \textcolor{keywordflow}{break};
80             \textcolor{keywordflow}{case} \hyperlink{classOkular_1_1SettingsCore_1_1EnumRenderMode_aae172bdb345dda4d639e763709ea357aa58af23c7fbd8ea1998995a8eaffa125d}{Okular::SettingsCore::EnumRenderMode::Paper}:
81                 paperColor = \hyperlink{classOkular_1_1SettingsCore_ab59e5e75137763e3a97b545dcfd2bb30}{Okular::SettingsCore::paperColor}();
82                 backgroundColor = paperColor;
83                 \textcolor{keywordflow}{break};
84             \textcolor{keywordflow}{case} \hyperlink{classOkular_1_1SettingsCore_1_1EnumRenderMode_aae172bdb345dda4d639e763709ea357aa4ed9520dc788e5254440ebd166aedbd8}{Okular::SettingsCore::EnumRenderMode::Recolor}
      :
85                 backgroundColor = \hyperlink{classOkular_1_1Settings_a3b5300e5e203a1d4e9d08b2edfe4f152}{Okular::Settings::recolorBackground}();
86                 \textcolor{keywordflow}{break};
87             \textcolor{keywordflow}{default}: ;
88         \}
89     \}
90     destPainter->fillRect( limits, backgroundColor );
91 
92     \textcolor{keyword}{const} \textcolor{keywordtype}{bool} hasTilesManager = page->\hyperlink{classOkular_1_1Page_adc0913df4b9c04bae5612e9861673bb5}{hasTilesManager}( observer );
93     \textcolor{keyword}{const} QPixmap *pixmap = 0;
94 
95     \textcolor{keywordflow}{if} ( !hasTilesManager )
96     \{
98         pixmap = page->\_o\_nearestPixmap( observer, scaledWidth, scaledHeight );
99 
101         \textcolor{keywordtype}{double} pixmapRescaleRatio = pixmap ? scaledWidth / (double)pixmap->width() : -1;
102         \textcolor{keywordtype}{long} pixmapPixels = pixmap ? (long)pixmap->width() * (long)pixmap->height() : 0;
103         \textcolor{keywordflow}{if} ( !pixmap || pixmapRescaleRatio > 20.0 || pixmapRescaleRatio < 0.25 ||
104              (scaledWidth != pixmap->width() && pixmapPixels > 6000000L) )
105         \{
106             \textcolor{comment}{// draw something on the blank page: the okular icon or a cross (as a fallback)}
107             \textcolor{keywordflow}{if} ( !busyPixmap->isNull() )
108             \{
109                 destPainter->drawPixmap( QPoint( 10, 10 ), *busyPixmap );
110             \}
111             \textcolor{keywordflow}{else}
112             \{
113                 destPainter->setPen( Qt::gray );
114                 destPainter->drawLine( 0, 0, croppedWidth-1, croppedHeight-1 );
115                 destPainter->drawLine( 0, croppedHeight-1, croppedWidth-1, 0 );
116             \}
117             \textcolor{keywordflow}{return};
118         \}
119     \}
120 
122     \textcolor{keywordtype}{bool} canDrawHighlights = (flags & \hyperlink{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01a3582deaa27eb857b1bbdd54e6174b3b5}{Highlights}) && !page->m\_highlights.isEmpty();
123     \textcolor{keywordtype}{bool} canDrawTextSelection = (flags & \hyperlink{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01a76eae803a84abe4cdf3c21b73c2d266d}{TextSelection}) && page->
      \hyperlink{classOkular_1_1Page_a8b357ca7010d815f378094a7ba279a33}{textSelection}();
124     \textcolor{keywordtype}{bool} canDrawAnnotations = (flags & \hyperlink{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01a87c63f97188bb13cbafd5ae63be3fe40}{Annotations}) && !page->m\_annotations.isEmpty();
125     \textcolor{keywordtype}{bool} enhanceLinks = (flags & \hyperlink{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01a388b8bc0e65542c5b36324ed9331b982}{EnhanceLinks}) && 
      \hyperlink{classOkular_1_1Settings_ae49aa56e379f78d0295ce2afddfa7763}{Okular::Settings::highlightLinks}();
126     \textcolor{keywordtype}{bool} enhanceImages = (flags & \hyperlink{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01acbf8b61fc5bea59ff83332b5219a8ed2}{EnhanceImages}) && 
      \hyperlink{classOkular_1_1Settings_a41a6c31cc235e4854b19ce95fde54e83}{Okular::Settings::highlightImages}();
127     \textcolor{comment}{// vectors containing objects to draw}
128     \textcolor{comment}{// make this a qcolor, rect map, since we don't need}
129     \textcolor{comment}{// to know s\_id here! we are only drawing this right?}
130     \hyperlink{classQList}{QList< QPair<QColor, Okular::NormalizedRect>} > * 
      bufferedHighlights = 0;
131     \hyperlink{classQList}{QList< Okular::Annotation * >} * bufferedAnnotations = 0;
132     \hyperlink{classQList}{QList< Okular::Annotation * >} * unbufferedAnnotations = 0;
133     \hyperlink{classOkular_1_1Annotation}{Okular::Annotation} *boundingRectOnlyAnn = 0; \textcolor{comment}{// Paint the bounding rect of this
       annotation}
134     \textcolor{comment}{// fill up lists with visible annotation/highlight objects/text selections}
135     \textcolor{keywordflow}{if} ( canDrawHighlights || canDrawTextSelection || canDrawAnnotations )
136     \{
137         \textcolor{comment}{// precalc normalized 'limits rect' for intersection}
138         \textcolor{keywordtype}{double} nXMin = ( (double)limits.left() / (double)scaledWidth ) + crop.
      \hyperlink{classOkular_1_1NormalizedRect_a76336fe9d733f2b559cf8df3ef48f9e7}{left},
139                nXMax = ( (double)limits.right() / (double)scaledWidth )  + crop.
      \hyperlink{classOkular_1_1NormalizedRect_a76336fe9d733f2b559cf8df3ef48f9e7}{left},
140                nYMin = ( (double)limits.top() / (double)scaledHeight ) + crop.
      \hyperlink{classOkular_1_1NormalizedRect_acfb70f6417c993508d50090b512cb954}{top},
141                nYMax = ( (double)limits.bottom() / (double)scaledHeight ) + crop.
      \hyperlink{classOkular_1_1NormalizedRect_acfb70f6417c993508d50090b512cb954}{top};
142         \textcolor{comment}{// append all highlights inside limits to their list}
143         \textcolor{keywordflow}{if} ( canDrawHighlights )
144         \{
145             \textcolor{keywordflow}{if} ( !bufferedHighlights )
146                  bufferedHighlights = \textcolor{keyword}{new} 
      \hyperlink{classQList}{QList< QPair<QColor, Okular::NormalizedRect>} >();
147 \textcolor{comment}{/*            else}
148 \textcolor{comment}{            \{*/}
149                 
150                 \hyperlink{classOkular_1_1NormalizedRect}{Okular::NormalizedRect}* limitRect = \textcolor{keyword}{new} 
      \hyperlink{classOkular_1_1NormalizedRect}{Okular::NormalizedRect}(nXMin, nYMin, nXMax, nYMax );
151                 \hyperlink{classQLinkedList}{QLinkedList< Okular::HighlightAreaRect * >::const\_iterator}
       h2It = page->m\_highlights.constBegin(), hEnd = page->m\_highlights.constEnd();
152                 Okular::HighlightAreaRect::const\_iterator hIt;
153                 \textcolor{keywordflow}{for} ( ; h2It != hEnd; ++h2It )
154                     \textcolor{keywordflow}{for} (hIt=(*h2It)->constBegin(); hIt!=(*h2It)->constEnd(); ++hIt)
155                     \{
156                         \textcolor{keywordflow}{if} ((*hIt).intersects(limitRect))
157                             bufferedHighlights->append( qMakePair((*h2It)->color,*hIt) );
158                     \}
159                 \textcolor{keyword}{delete} limitRect;
160             \textcolor{comment}{//\}}
161         \}
162         \textcolor{keywordflow}{if} ( canDrawTextSelection )
163         \{
164             \textcolor{keywordflow}{if} ( !bufferedHighlights )
165                  bufferedHighlights = \textcolor{keyword}{new} 
      \hyperlink{classQList}{QList< QPair<QColor, Okular::NormalizedRect>}  >();
166 \textcolor{comment}{/*            else}
167 \textcolor{comment}{            \{*/}
168                 \hyperlink{classOkular_1_1NormalizedRect}{Okular::NormalizedRect}* limitRect = \textcolor{keyword}{new} 
      \hyperlink{classOkular_1_1NormalizedRect}{Okular::NormalizedRect}(nXMin, nYMin, nXMax, nYMax );
169                 \textcolor{keyword}{const} \hyperlink{classOkular_1_1RegularAreaRect}{Okular::RegularAreaRect} *textSelection = page->
      \hyperlink{classOkular_1_1Page_a8b357ca7010d815f378094a7ba279a33}{textSelection}();
170                 Okular::HighlightAreaRect::const\_iterator hIt = textSelection->constBegin(), hEnd = 
      textSelection->constEnd();
171                 \textcolor{keywordflow}{for} ( ; hIt != hEnd; ++hIt )
172                 \{
173                     \textcolor{keywordflow}{if} ( (*hIt).intersects( limitRect ) )
174                         bufferedHighlights->append( qMakePair( page->
      \hyperlink{classOkular_1_1Page_a976e5f9876ca12676203fce0a6323cc8}{textSelectionColor}(), *hIt ) );
175                 \}
176                 \textcolor{keyword}{delete} limitRect;
177             \textcolor{comment}{//\}}
178         \}
179         \textcolor{comment}{// append annotations inside limits to the un/buffered list}
180         \textcolor{keywordflow}{if} ( canDrawAnnotations )
181         \{
182             \hyperlink{classQLinkedList}{QLinkedList< Okular::Annotation * >::const\_iterator}
       aIt = page->m\_annotations.constBegin(), aEnd = page->m\_annotations.constEnd();
183             \textcolor{keywordflow}{for} ( ; aIt != aEnd; ++aIt )
184             \{
185                 \hyperlink{classOkular_1_1Annotation}{Okular::Annotation} * ann = *aIt;
186                 \textcolor{keywordtype}{int} flags = ann->\hyperlink{classOkular_1_1Annotation_a3d6f7ee5057155b90e76c24768880947}{flags}();
187 
188                 \textcolor{keywordflow}{if} ( flags & \hyperlink{classOkular_1_1Annotation_a8a214541446745761efeda70b3a4302ea053e3857f5c7f494a996e649e5e97244}{Okular::Annotation::Hidden} )
189                     \textcolor{keywordflow}{continue};
190 
191                 \textcolor{keywordflow}{if} ( flags & \hyperlink{classOkular_1_1Annotation_a8a214541446745761efeda70b3a4302ea75f088f5533ace9d9d47a506b707f5a1}{Okular::Annotation::ExternallyDrawn} )
192                 \{
193                     \textcolor{comment}{// ExternallyDrawn annots are never rendered by PagePainter.}
194                     \textcolor{comment}{// Just paint the boundingRect if the annot is BeingMoved}
195                     \textcolor{keywordflow}{if} ( flags & \hyperlink{classOkular_1_1Annotation_a8a214541446745761efeda70b3a4302ea9cd51e0fe53aac93798a205e7fb5c04a}{Okular::Annotation::BeingMoved} )
196                         boundingRectOnlyAnn = ann;
197                     \textcolor{keywordflow}{continue};
198                 \}
199 
200                 \textcolor{keywordtype}{bool} intersects = ann->\hyperlink{classOkular_1_1Annotation_a950ea9c7993878729eb4b6b0ea922436}{transformedBoundingRectangle}().
      \hyperlink{classOkular_1_1NormalizedRect_a9c2d89ccafd17802316c90406c6ec756}{intersects}( nXMin, nYMin, nXMax, nYMax );
201                 \textcolor{keywordflow}{if} ( ann->\hyperlink{classOkular_1_1Annotation_af9833449767eacd740f377e69a1fdd48}{subType}() == \hyperlink{classOkular_1_1Annotation_af71b46e37d5f850b97d5c4de3be9aac0a48f93d5a9352abc4e38a45f69075e504}{Okular::Annotation::AText} )
202                 \{
203                     \hyperlink{classOkular_1_1TextAnnotation}{Okular::TextAnnotation} * ta = \textcolor{keyword}{static\_cast<} 
      \hyperlink{classOkular_1_1TextAnnotation}{Okular::TextAnnotation} * \textcolor{keyword}{>}( ann );
204                     \textcolor{keywordflow}{if} ( ta->\hyperlink{classOkular_1_1TextAnnotation_acf75a9a22542d3008a486298972e6dcf}{textType}() == 
      \hyperlink{classOkular_1_1TextAnnotation_af560204454bf812797bc95bea730b06eaf7d7133e8e4850bf030e108537a9887b}{Okular::TextAnnotation::Linked} )
205                     \{
206                         \hyperlink{classOkular_1_1NormalizedRect}{Okular::NormalizedRect} iconrect( ann->
      \hyperlink{classOkular_1_1Annotation_a950ea9c7993878729eb4b6b0ea922436}{transformedBoundingRectangle}().\hyperlink{classOkular_1_1NormalizedRect_a76336fe9d733f2b559cf8df3ef48f9e7}{left},
207                                                          ann->
      \hyperlink{classOkular_1_1Annotation_a950ea9c7993878729eb4b6b0ea922436}{transformedBoundingRectangle}().\hyperlink{classOkular_1_1NormalizedRect_acfb70f6417c993508d50090b512cb954}{top},
208                                                          ann->
      \hyperlink{classOkular_1_1Annotation_a950ea9c7993878729eb4b6b0ea922436}{transformedBoundingRectangle}().\hyperlink{classOkular_1_1NormalizedRect_a76336fe9d733f2b559cf8df3ef48f9e7}{left} + 
      \hyperlink{pagepainter_8cpp_a32fe52c433b27892263587c64567dc5a}{TEXTANNOTATION\_ICONSIZE} / page->\hyperlink{classOkular_1_1Page_a57114e88281da2a51b1bb0d5d4996d53}{width}(),
209                                                          ann->
      \hyperlink{classOkular_1_1Annotation_a950ea9c7993878729eb4b6b0ea922436}{transformedBoundingRectangle}().\hyperlink{classOkular_1_1NormalizedRect_acfb70f6417c993508d50090b512cb954}{top} + 
      \hyperlink{pagepainter_8cpp_a32fe52c433b27892263587c64567dc5a}{TEXTANNOTATION\_ICONSIZE} / page->\hyperlink{classOkular_1_1Page_a67246a32b3e625946eb5c685b8372a4f}{height}() );
210                         intersects = iconrect.\hyperlink{classOkular_1_1NormalizedRect_a9c2d89ccafd17802316c90406c6ec756}{intersects}( nXMin, nYMin, nXMax, nYMax );
211                     \}
212                 \}
213                 \textcolor{keywordflow}{if} ( intersects )
214                 \{
215                     \hyperlink{classOkular_1_1Annotation_af71b46e37d5f850b97d5c4de3be9aac0}{Okular::Annotation::SubType} type = ann->
      \hyperlink{classOkular_1_1Annotation_af9833449767eacd740f377e69a1fdd48}{subType}();
216                     \textcolor{keywordflow}{if} ( type == \hyperlink{classOkular_1_1Annotation_af71b46e37d5f850b97d5c4de3be9aac0a7035dc978d8b79958f34e3d164838726}{Okular::Annotation::ALine} || type == 
      \hyperlink{classOkular_1_1Annotation_af71b46e37d5f850b97d5c4de3be9aac0a03e002f9ae62005b2d7c7f1445507501}{Okular::Annotation::AHighlight} ||
217                          type == \hyperlink{classOkular_1_1Annotation_af71b46e37d5f850b97d5c4de3be9aac0a4ed60063584ceb146c2a378f0df4ed37}{Okular::Annotation::AInk}  \textcolor{comment}{/*|| (type ==
       Annotation::AGeom && ann->style().opacity() < 0.99)*/} )
218                     \{
219                         \textcolor{keywordflow}{if} ( !bufferedAnnotations )
220                             bufferedAnnotations = \textcolor{keyword}{new} 
      \hyperlink{classQList}{QList< Okular::Annotation * >}();
221                         bufferedAnnotations->append( ann );
222                     \}
223                     \textcolor{keywordflow}{else}
224                     \{
225                         \textcolor{keywordflow}{if} ( !unbufferedAnnotations )
226                             unbufferedAnnotations = \textcolor{keyword}{new} 
      \hyperlink{classQList}{QList< Okular::Annotation * >}();
227                         unbufferedAnnotations->append( ann );
228                     \}
229                 \}
230             \}
231         \}
232         \textcolor{comment}{// end of intersections checking}
233     \}
234 
236     \textcolor{keywordtype}{bool} bufferAccessibility = (flags & \hyperlink{classPagePainter_ae7f51ac72a598d2753cfc35ecdb51e01ac3c6879723c19935fb6fe250d0feca17}{Accessibility}) && 
      \hyperlink{classOkular_1_1SettingsCore_af01449e331a4e973d5cb3879a3e76081}{Okular::SettingsCore::changeColors}() && (
      \hyperlink{classOkular_1_1SettingsCore_a6fcb9ee5ad7a92b49ad31344771cca2d}{Okular::SettingsCore::renderMode}() != 
      \hyperlink{classOkular_1_1SettingsCore_1_1EnumRenderMode_aae172bdb345dda4d639e763709ea357aa58af23c7fbd8ea1998995a8eaffa125d}{Okular::SettingsCore::EnumRenderMode::Paper});
237     \textcolor{keywordtype}{bool} useBackBuffer = bufferAccessibility || bufferedHighlights || bufferedAnnotations || viewPortPoint;
238     QPixmap * backPixmap = 0;
239     QPainter * mixedPainter = 0;
240     QRect limitsInPixmap = limits.translated( scaledCrop.topLeft() );
241         \textcolor{comment}{// limits within full (scaled but uncropped) pixmap}
242 
244     \textcolor{keywordflow}{if} ( !useBackBuffer )
245     \{
246         \textcolor{keywordflow}{if} ( hasTilesManager )
247         \{
248             \textcolor{keyword}{const} \hyperlink{classOkular_1_1NormalizedRect}{Okular::NormalizedRect} normalizedLimits( limitsInPixmap, 
      scaledWidth, scaledHeight );
249             \textcolor{keyword}{const} \hyperlink{classQList}{QList<Okular::Tile>} tiles = page->\hyperlink{classOkular_1_1Page_a5dea3e142724e8c320b50bba420bd03b}{tilesAt}( observer, 
      normalizedLimits );
250             \hyperlink{classQList}{QList<Okular::Tile>::const\_iterator} tIt = tiles.constBegin()
      , tEnd = tiles.constEnd();
251             \textcolor{keywordflow}{while} ( tIt != tEnd )
252             \{
253                 \textcolor{keyword}{const} \hyperlink{classOkular_1_1Tile}{Okular::Tile} &tile = *tIt;
254                 QRect tileRect = tile.\hyperlink{classOkular_1_1Tile_af98992ebbaa390a12a942bff6c246fca}{rect}().\hyperlink{classOkular_1_1NormalizedRect_a006897c5fcff2c3a97b4141f1a967513}{geometry}( scaledWidth, scaledHeight ).translated( 
      -scaledCrop.topLeft() );
255                 QRect limitsInTile = limits & tileRect;
256                 \textcolor{keywordflow}{if} ( !limitsInTile.isEmpty() )
257                 \{
258                     \textcolor{keywordflow}{if} ( tile.\hyperlink{classOkular_1_1Tile_ad20431332cb0fb2844fa2238cc728a9f}{pixmap}()->width() == tileRect.width() && tile.
      \hyperlink{classOkular_1_1Tile_ad20431332cb0fb2844fa2238cc728a9f}{pixmap}()->height() == tileRect.height() )
259                         destPainter->drawPixmap( limitsInTile.topLeft(), *(tile.
      \hyperlink{classOkular_1_1Tile_ad20431332cb0fb2844fa2238cc728a9f}{pixmap}()),
260                                 limitsInTile.translated( -tileRect.topLeft() ) );
261                     \textcolor{keywordflow}{else}
262                         destPainter->drawPixmap( tileRect, *(tile.\hyperlink{classOkular_1_1Tile_ad20431332cb0fb2844fa2238cc728a9f}{pixmap}()) );
263                 \}
264                 tIt++;
265             \}
266         \}
267         \textcolor{keywordflow}{else}
268         \{
269             \textcolor{comment}{// 4A.1. if size is ok, draw the page pixmap using painter}
270             \textcolor{keywordflow}{if} ( pixmap->width() == scaledWidth && pixmap->height() == scaledHeight )
271                 destPainter->drawPixmap( limits.topLeft(), *pixmap, limitsInPixmap );
272 
273             \textcolor{comment}{// else draw a scaled portion of the magnified pixmap}
274             \textcolor{keywordflow}{else}
275             \{
276                 QImage destImage;
277                 scalePixmapOnImage( destImage, pixmap, scaledWidth, scaledHeight, limitsInPixmap );
278                 destPainter->drawImage( limits.left(), limits.top(), destImage, 0, 0,
279                                          limits.width(),limits.height() );
280             \}
281         \}
282 
283         \textcolor{comment}{// 4A.2. active painter is the one passed to this method}
284         mixedPainter = destPainter;
285     \}
287     \textcolor{keywordflow}{else}
288     \{
289         \textcolor{comment}{// the image over which we are going to draw}
290         QImage backImage;
291 
292         \textcolor{keywordtype}{bool} has\_alpha;
293         \textcolor{keywordflow}{if} ( pixmap )
294             has\_alpha = pixmap->hasAlpha();
295         \textcolor{keywordflow}{else}
296             has\_alpha = \textcolor{keyword}{true};
297 
298         \textcolor{keywordflow}{if} ( hasTilesManager )
299         \{
300             backImage = QImage( limits.width(), limits.height(), QImage::Format\_ARGB32\_Premultiplied );
301             backImage.fill( paperColor.rgb() );
302             QPainter p( &backImage );
303             \textcolor{keyword}{const} \hyperlink{classOkular_1_1NormalizedRect}{Okular::NormalizedRect} normalizedLimits( limitsInPixmap, 
      scaledWidth, scaledHeight );
304             \textcolor{keyword}{const} \hyperlink{classQList}{QList<Okular::Tile>} tiles = page->\hyperlink{classOkular_1_1Page_a5dea3e142724e8c320b50bba420bd03b}{tilesAt}( observer, 
      normalizedLimits );
305             \hyperlink{classQList}{QList<Okular::Tile>::const\_iterator} tIt = tiles.constBegin()
      , tEnd = tiles.constEnd();
306             \textcolor{keywordflow}{while} ( tIt != tEnd )
307             \{
308                 \textcolor{keyword}{const} \hyperlink{classOkular_1_1Tile}{Okular::Tile} &tile = *tIt;
309                 QRect tileRect = tile.\hyperlink{classOkular_1_1Tile_af98992ebbaa390a12a942bff6c246fca}{rect}().\hyperlink{classOkular_1_1NormalizedRect_a006897c5fcff2c3a97b4141f1a967513}{geometry}( scaledWidth, scaledHeight ).translated( 
      -scaledCrop.topLeft() );
310                 QRect limitsInTile = limits & tileRect;
311                 \textcolor{keywordflow}{if} ( !limitsInTile.isEmpty() )
312                 \{
313                     \textcolor{keywordflow}{if} ( !tile.\hyperlink{classOkular_1_1Tile_ad20431332cb0fb2844fa2238cc728a9f}{pixmap}()->hasAlpha() )
314                         has\_alpha = \textcolor{keyword}{false};
315 
316                     \textcolor{keywordflow}{if} ( tile.\hyperlink{classOkular_1_1Tile_ad20431332cb0fb2844fa2238cc728a9f}{pixmap}()->width() == tileRect.width() && tile.
      \hyperlink{classOkular_1_1Tile_ad20431332cb0fb2844fa2238cc728a9f}{pixmap}()->height() == tileRect.height() )
317                     \{
318                         p.drawPixmap( limitsInTile.translated( -limits.topLeft() ).topLeft(), *(tile.
      \hyperlink{classOkular_1_1Tile_ad20431332cb0fb2844fa2238cc728a9f}{pixmap}()),
319                                 limitsInTile.translated( -tileRect.topLeft() ) );
320                     \}
321                     \textcolor{keywordflow}{else}
322                     \{
323                         \textcolor{keywordtype}{double} xScale = tile.\hyperlink{classOkular_1_1Tile_ad20431332cb0fb2844fa2238cc728a9f}{pixmap}()->width() / (double)tileRect.width();
324                         \textcolor{keywordtype}{double} yScale = tile.\hyperlink{classOkular_1_1Tile_ad20431332cb0fb2844fa2238cc728a9f}{pixmap}()->height() / (double)tileRect.height();
325                         QTransform transform( xScale, 0, 0, yScale, 0, 0 );
326                         p.drawPixmap( limitsInTile.translated( -limits.topLeft() ), *(tile.
      \hyperlink{classOkular_1_1Tile_ad20431332cb0fb2844fa2238cc728a9f}{pixmap}()),
327                                 transform.mapRect( limitsInTile ).translated( -transform.mapRect( tileRect 
      ).topLeft() ) );
328                     \}
329                 \}
330                 ++tIt;
331             \}
332             p.end();
333         \}
334         \textcolor{keywordflow}{else}
335         \{
336             \textcolor{comment}{// 4B.1. draw the page pixmap: normal or scaled}
337             \textcolor{keywordflow}{if} ( pixmap->width() == scaledWidth && pixmap->height() == scaledHeight )
338                 cropPixmapOnImage( backImage, pixmap, limitsInPixmap );
339             \textcolor{keywordflow}{else}
340                 scalePixmapOnImage( backImage, pixmap, scaledWidth, scaledHeight, limitsInPixmap );
341         \}
342 
343         \textcolor{comment}{// 4B.2. modify pixmap following accessibility settings}
344         \textcolor{keywordflow}{if} ( bufferAccessibility )
345         \{
346             \textcolor{keywordflow}{switch} ( \hyperlink{classOkular_1_1SettingsCore_a6fcb9ee5ad7a92b49ad31344771cca2d}{Okular::SettingsCore::renderMode}() )
347             \{
348                 \textcolor{keywordflow}{case} \hyperlink{classOkular_1_1SettingsCore_1_1EnumRenderMode_aae172bdb345dda4d639e763709ea357aae3a52d8c06b668f28a3f3d646c49d3b0}{Okular::SettingsCore::EnumRenderMode::Inverted}
      :
349                     \textcolor{comment}{// Invert image pixels using QImage internal function}
350                     backImage.invertPixels(QImage::InvertRgb);
351                     \textcolor{keywordflow}{break};
352                 \textcolor{keywordflow}{case} \hyperlink{classOkular_1_1SettingsCore_1_1EnumRenderMode_aae172bdb345dda4d639e763709ea357aa4ed9520dc788e5254440ebd166aedbd8}{Okular::SettingsCore::EnumRenderMode::Recolor}
      :
353                     \textcolor{comment}{// Recolor image using Blitz::flatten with dither:0}
354                     Blitz::flatten( backImage, 
      \hyperlink{classOkular_1_1Settings_ad2fa94bea1f5cd63394fb0eb43515f72}{Okular::Settings::recolorForeground}(), 
      \hyperlink{classOkular_1_1Settings_a3b5300e5e203a1d4e9d08b2edfe4f152}{Okular::Settings::recolorBackground}() );
355                     \textcolor{keywordflow}{break};
356                 \textcolor{keywordflow}{case} \hyperlink{classOkular_1_1SettingsCore_1_1EnumRenderMode_aae172bdb345dda4d639e763709ea357aacfc5ee223333e478da6fb379a9eaa23a}{Okular::SettingsCore::EnumRenderMode::BlackWhite}
      :
357                     \textcolor{comment}{// Manual Gray and Contrast}
358                     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} * \hyperlink{structdrawinf_af73f66288002f0a25c7843a534bf1340}{data} = (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} *)backImage.bits();
359                     \textcolor{keywordtype}{int} val, pixels = backImage.width() * backImage.height(),
360                         con = \hyperlink{classOkular_1_1Settings_a3f705adb7a04efb41f5f6acd6ef3bab9}{Okular::Settings::bWContrast}(), thr = 255 - 
      \hyperlink{classOkular_1_1Settings_a5246ad88486cd24b99606fcb063aa269}{Okular::Settings::bWThreshold}();
361                     \textcolor{keywordflow}{for}( \textcolor{keywordtype}{int} i = 0; i < pixels; ++i )
362                     \{
363                         val = qGray( data[i] );
364                         \textcolor{keywordflow}{if} ( val > thr )
365                             val = 128 + (127 * (val - thr)) / (255 - thr);
366                         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} ( val < thr )
367                             val = (128 * val) / thr;
368                         \textcolor{keywordflow}{if} ( con > 2 )
369                         \{
370                             val = con * ( val - thr ) / 2 + thr;
371                             \textcolor{keywordflow}{if} ( val > 255 )
372                                 val = 255;
373                             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} ( val < 0 )
374                                 val = 0;
375                         \}
376                         data[i] = qRgba( val, val, val, 255 );
377                     \}
378                     \textcolor{keywordflow}{break};
379             \}
380         \}
381         \textcolor{comment}{// 4B.3. highlight rects in page}
382         \textcolor{keywordflow}{if} ( bufferedHighlights )
383         \{
384             \textcolor{comment}{// draw highlights that are inside the 'limits' paint region}
385             \hyperlink{classQList}{QList< QPair<QColor, Okular::NormalizedRect>} >
      ::const\_iterator hIt = bufferedHighlights->constBegin(), hEnd = bufferedHighlights->constEnd();
386             \textcolor{keywordflow}{for} ( ; hIt != hEnd; ++hIt )
387             \{
388                 \textcolor{keyword}{const} \hyperlink{classOkular_1_1NormalizedRect}{Okular::NormalizedRect} & r = (*hIt).second;
389                 \textcolor{comment}{// find out the rect to highlight on pixmap}
390                 QRect highlightRect = r.\hyperlink{classOkular_1_1NormalizedRect_a006897c5fcff2c3a97b4141f1a967513}{geometry}( scaledWidth, scaledHeight ).translated( -
      scaledCrop.topLeft() ).intersect( limits );
391                 highlightRect.translate( -limits.left(), -limits.top() );
392 
393                 \textcolor{comment}{// highlight composition (product: highlight color * destcolor)}
394                 \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} * data = (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} *)backImage.bits();
395                 \textcolor{keywordtype}{int} val, newR, newG, newB,
396                     rh = (*hIt).first.red(),
397                     gh = (*hIt).first.green(),
398                     bh = (*hIt).first.blue(),
399                     offset = highlightRect.top() * backImage.width();
400                 \textcolor{keywordflow}{for}( \textcolor{keywordtype}{int} y = highlightRect.top(); y <= highlightRect.bottom(); ++y )
401                 \{
402                     \textcolor{keywordflow}{for}( \textcolor{keywordtype}{int} x = highlightRect.left(); x <= highlightRect.right(); ++x )
403                     \{
404                         val = data[ x + offset ];
405                         \textcolor{comment}{//for odt or epub}
406                         \textcolor{keywordflow}{if}(has\_alpha)
407                         \{
408                             newR = qRed(val);
409                             newG = qGreen(val);
410                             newB = qBlue(val);
411 
412                             \textcolor{keywordflow}{if}(newR == newG && newG == newB && newR == 0)
413                                 newR = newG = newB = 255;
414 
415                             newR = (newR * rh) / 255;
416                             newG = (newG * gh) / 255;
417                             newB = (newB * bh) / 255;
418                         \}
419                         \textcolor{keywordflow}{else}
420                         \{
421                             newR = (qRed(val) * rh) / 255;
422                             newG = (qGreen(val) * gh) / 255;
423                             newB = (qBlue(val) * bh) / 255;
424                         \}
425                         data[ x + offset ] = qRgba( newR, newG, newB, 255 );
426                     \}
427                     offset += backImage.width();
428                 \}
429             \}
430         \}
431         \textcolor{comment}{// 4B.4. paint annotations [COMPOSITED ONES]}
432         \textcolor{keywordflow}{if} ( bufferedAnnotations )
433         \{
434             \textcolor{comment}{// Albert: This is quite "heavy" but all the backImage that reach here are
       QImage::Format\_ARGB32\_Premultiplied}
435             \textcolor{comment}{// and have to be so that the QPainter::CompositionMode\_Multiply works}
436             \textcolor{comment}{// we could also put a}
437             \textcolor{comment}{// backImage = backImage.convertToFormat(QImage::Format\_ARGB32\_Premultiplied)}
438             \textcolor{comment}{// that would be almost a noop, but we'll leave the assert for now}
439             Q\_ASSERT(backImage.format() == QImage::Format\_ARGB32\_Premultiplied);
440             \textcolor{comment}{// precalc constants for normalizing [0,1] page coordinates into normalized [0,1] limit rect
       coordinates}
441             \textcolor{keywordtype}{double} pageScale = (double)croppedWidth / page->\hyperlink{classOkular_1_1Page_a57114e88281da2a51b1bb0d5d4996d53}{width}();
442             \textcolor{keywordtype}{double} xOffset = (double)limits.left() / (double)scaledWidth + crop.
      \hyperlink{classOkular_1_1NormalizedRect_a76336fe9d733f2b559cf8df3ef48f9e7}{left},
443                    xScale = (\textcolor{keywordtype}{double})scaledWidth / (double)limits.width(),
444                    yOffset = (double)limits.top() / (double)scaledHeight + crop.
      \hyperlink{classOkular_1_1NormalizedRect_acfb70f6417c993508d50090b512cb954}{top},
445                    yScale = (\textcolor{keywordtype}{double})scaledHeight / (double)limits.height();
446 
447             \textcolor{comment}{// paint all buffered annotations in the page}
448             \hyperlink{classQList}{QList< Okular::Annotation * >::const\_iterator} aIt 
      = bufferedAnnotations->constBegin(), aEnd = bufferedAnnotations->constEnd();
449             \textcolor{keywordflow}{for} ( ; aIt != aEnd; ++aIt )
450             \{
451                 \hyperlink{classOkular_1_1Annotation}{Okular::Annotation} * a = *aIt;
452                 \hyperlink{classOkular_1_1Annotation_af71b46e37d5f850b97d5c4de3be9aac0}{Okular::Annotation::SubType} type = a->
      \hyperlink{classOkular_1_1Annotation_af9833449767eacd740f377e69a1fdd48}{subType}();
453                 QColor acolor = a->\hyperlink{classOkular_1_1Annotation_ae1f845ddbd6d524b2b388c6c9ef26423}{style}().\hyperlink{classOkular_1_1Annotation_1_1Style_a2c32cb2b41ef8732ddcd3d3dffc20b7d}{color}();
454                 \textcolor{keywordflow}{if} ( !acolor.isValid() )
455                     acolor = Qt::yellow;
456                 acolor.setAlphaF( a->\hyperlink{classOkular_1_1Annotation_ae1f845ddbd6d524b2b388c6c9ef26423}{style}().\hyperlink{classOkular_1_1Annotation_1_1Style_abb17b057d91f128793b3fa3d4b556a45}{opacity}() );
457 
458                 \textcolor{comment}{// draw LineAnnotation MISSING: all}
459                 \textcolor{keywordflow}{if} ( type == \hyperlink{classOkular_1_1Annotation_af71b46e37d5f850b97d5c4de3be9aac0a7035dc978d8b79958f34e3d164838726}{Okular::Annotation::ALine} )
460                 \{
461                     \textcolor{comment}{// get the annotation}
462                     \hyperlink{classOkular_1_1LineAnnotation}{Okular::LineAnnotation} * la = (
      \hyperlink{classOkular_1_1LineAnnotation}{Okular::LineAnnotation} *) a;
463 
464                     NormalizedPath path;
465                     \textcolor{comment}{// normalize page point to image}
466                     \textcolor{keyword}{const} \hyperlink{classQLinkedList}{QLinkedList<Okular::NormalizedPoint>} points =
       la->\hyperlink{classOkular_1_1LineAnnotation_a1e3b104d9572967e66f35a15c335f37c}{transformedLinePoints}();
467                     \hyperlink{classQLinkedList}{QLinkedList<Okular::NormalizedPoint>::const\_iterator}
       it = points.constBegin();
468                     \hyperlink{classQLinkedList}{QLinkedList<Okular::NormalizedPoint>::const\_iterator}
       itEnd = points.constEnd();
469                     \textcolor{keywordflow}{for} ( ; it != itEnd; ++it )
470                     \{
471                         \hyperlink{classOkular_1_1NormalizedPoint}{Okular::NormalizedPoint} point;
472                         point.\hyperlink{classOkular_1_1NormalizedPoint_a857f49b9bc7712430d167472ef9dbd94}{x} = ( (*it).x - xOffset) * xScale;
473                         point.\hyperlink{classOkular_1_1NormalizedPoint_ac2276daabda627d5f82bb1532c293047}{y} = ( (*it).y - yOffset) * yScale;
474                         path.append( point );
475                     \}
476 
477                     \textcolor{keyword}{const} QPen linePen = buildPen( a, a->\hyperlink{classOkular_1_1Annotation_ae1f845ddbd6d524b2b388c6c9ef26423}{style}().\hyperlink{classOkular_1_1Annotation_1_1Style_a5a8e23f3a4f95e25f45770937dc82948}{width}(), a->
      \hyperlink{classOkular_1_1Annotation_ae1f845ddbd6d524b2b388c6c9ef26423}{style}().\hyperlink{classOkular_1_1Annotation_1_1Style_a2c32cb2b41ef8732ddcd3d3dffc20b7d}{color}() );
478                     QBrush fillBrush;
479 
480                     \textcolor{keywordflow}{if} ( la->\hyperlink{classOkular_1_1LineAnnotation_a5d2d587e08762b48ded428be2e390e79}{lineClosed}() && la->\hyperlink{classOkular_1_1LineAnnotation_a240bcd7154afdf61c526295134abdc0f}{lineInnerColor}().isValid() )
481                         fillBrush = QBrush( la->\hyperlink{classOkular_1_1LineAnnotation_a240bcd7154afdf61c526295134abdc0f}{lineInnerColor}() );
482 
483                     \textcolor{comment}{// draw the line as normalized path into image}
484                     drawShapeOnImage( backImage, path, la->\hyperlink{classOkular_1_1LineAnnotation_a5d2d587e08762b48ded428be2e390e79}{lineClosed}(),
485                                       linePen,
486                                       fillBrush, pageScale ,Multiply);
487 
488                     \textcolor{keywordflow}{if} ( path.count() == 2 && fabs( la->\hyperlink{classOkular_1_1LineAnnotation_a5ea35b2ee68172d9cf183d8778e34edb}{lineLeadingForwardPoint}() ) 
      > 0.1 )
489                     \{
490                         \hyperlink{classOkular_1_1NormalizedPoint}{Okular::NormalizedPoint} delta( la->
      \hyperlink{classOkular_1_1LineAnnotation_a1e3b104d9572967e66f35a15c335f37c}{transformedLinePoints}().last().x - la->
      \hyperlink{classOkular_1_1LineAnnotation_a1e3b104d9572967e66f35a15c335f37c}{transformedLinePoints}().first().x, la->
      \hyperlink{classOkular_1_1LineAnnotation_a1e3b104d9572967e66f35a15c335f37c}{transformedLinePoints}().first().y - la->
      \hyperlink{classOkular_1_1LineAnnotation_a1e3b104d9572967e66f35a15c335f37c}{transformedLinePoints}().last().y );
491                         \textcolor{keywordtype}{double} angle = atan2( delta.y, delta.x );
492                         \textcolor{keywordflow}{if} ( delta.y < 0 )
493                             angle += 2 * M\_PI;
494 
495                         \textcolor{keywordtype}{int} sign = la->\hyperlink{classOkular_1_1LineAnnotation_a5ea35b2ee68172d9cf183d8778e34edb}{lineLeadingForwardPoint}() > 0.0 ? 1 : -1;
496                         \textcolor{keywordtype}{double} LLx = fabs( la->\hyperlink{classOkular_1_1LineAnnotation_a5ea35b2ee68172d9cf183d8778e34edb}{lineLeadingForwardPoint}() ) * cos( 
      angle + sign * M\_PI\_2 + 2 * M\_PI ) / page->\hyperlink{classOkular_1_1Page_a57114e88281da2a51b1bb0d5d4996d53}{width}();
497                         \textcolor{keywordtype}{double} LLy = fabs( la->\hyperlink{classOkular_1_1LineAnnotation_a5ea35b2ee68172d9cf183d8778e34edb}{lineLeadingForwardPoint}() ) * sin( 
      angle + sign * M\_PI\_2 + 2 * M\_PI ) / page->\hyperlink{classOkular_1_1Page_a67246a32b3e625946eb5c685b8372a4f}{height}();
498 
499                         NormalizedPath path2;
500                         NormalizedPath path3;
501 
502                         \hyperlink{classOkular_1_1NormalizedPoint}{Okular::NormalizedPoint} point;
503                         point.\hyperlink{classOkular_1_1NormalizedPoint_a857f49b9bc7712430d167472ef9dbd94}{x} = ( la->\hyperlink{classOkular_1_1LineAnnotation_a1e3b104d9572967e66f35a15c335f37c}{transformedLinePoints}().first().x + LLx - 
      xOffset ) * xScale;
504                         point.\hyperlink{classOkular_1_1NormalizedPoint_ac2276daabda627d5f82bb1532c293047}{y} = ( la->\hyperlink{classOkular_1_1LineAnnotation_a1e3b104d9572967e66f35a15c335f37c}{transformedLinePoints}().first().y - LLy - 
      yOffset ) * yScale;
505                         path2.append( point );
506                         point.\hyperlink{classOkular_1_1NormalizedPoint_a857f49b9bc7712430d167472ef9dbd94}{x} = ( la->\hyperlink{classOkular_1_1LineAnnotation_a1e3b104d9572967e66f35a15c335f37c}{transformedLinePoints}().last().x + LLx - 
      xOffset ) * xScale;
507                         point.\hyperlink{classOkular_1_1NormalizedPoint_ac2276daabda627d5f82bb1532c293047}{y} = ( la->\hyperlink{classOkular_1_1LineAnnotation_a1e3b104d9572967e66f35a15c335f37c}{transformedLinePoints}().last().y - LLy - 
      yOffset ) * yScale;
508                         path3.append( point );
509                         \textcolor{comment}{// do we have the extension on the "back"?}
510                         \textcolor{keywordflow}{if} ( fabs( la->\hyperlink{classOkular_1_1LineAnnotation_a6a492d6aadd6d9ee879f85c5f24e99a0}{lineLeadingBackwardPoint}() ) > 0.1 )
511                         \{
512                             \textcolor{keywordtype}{double} LLEx = la->\hyperlink{classOkular_1_1LineAnnotation_a6a492d6aadd6d9ee879f85c5f24e99a0}{lineLeadingBackwardPoint}() * cos( 
      angle - sign * M\_PI\_2 + 2 * M\_PI ) / page->\hyperlink{classOkular_1_1Page_a57114e88281da2a51b1bb0d5d4996d53}{width}();
513                             \textcolor{keywordtype}{double} LLEy = la->\hyperlink{classOkular_1_1LineAnnotation_a6a492d6aadd6d9ee879f85c5f24e99a0}{lineLeadingBackwardPoint}() * sin( 
      angle - sign * M\_PI\_2 + 2 * M\_PI ) / page->\hyperlink{classOkular_1_1Page_a67246a32b3e625946eb5c685b8372a4f}{height}();
514                             point.\hyperlink{classOkular_1_1NormalizedPoint_a857f49b9bc7712430d167472ef9dbd94}{x} = ( la->\hyperlink{classOkular_1_1LineAnnotation_a1e3b104d9572967e66f35a15c335f37c}{transformedLinePoints}().first().x + LLEx 
      - xOffset ) * xScale;
515                             point.\hyperlink{classOkular_1_1NormalizedPoint_ac2276daabda627d5f82bb1532c293047}{y} = ( la->\hyperlink{classOkular_1_1LineAnnotation_a1e3b104d9572967e66f35a15c335f37c}{transformedLinePoints}().first().y - LLEy 
      - yOffset ) * yScale;
516                             path2.append( point );
517                             point.\hyperlink{classOkular_1_1NormalizedPoint_a857f49b9bc7712430d167472ef9dbd94}{x} = ( la->\hyperlink{classOkular_1_1LineAnnotation_a1e3b104d9572967e66f35a15c335f37c}{transformedLinePoints}().last().x + LLEx -
       xOffset ) * xScale;
518                             point.\hyperlink{classOkular_1_1NormalizedPoint_ac2276daabda627d5f82bb1532c293047}{y} = ( la->\hyperlink{classOkular_1_1LineAnnotation_a1e3b104d9572967e66f35a15c335f37c}{transformedLinePoints}().last().y - LLEy -
       yOffset ) * yScale;
519                             path3.append( point );
520                         \}
521                         \textcolor{keywordflow}{else}
522                         \{
523                             path2.append( path[0] );
524                             path3.append( path[1] );
525                         \}
526 
527                         drawShapeOnImage( backImage, path2, \textcolor{keyword}{false}, linePen, QBrush(), pageScale, Multiply )
      ;
528                         drawShapeOnImage( backImage, path3, \textcolor{keyword}{false}, linePen, QBrush(), pageScale, Multiply )
      ;
529                     \}
530                 \}
531                 \textcolor{comment}{// draw HighlightAnnotation MISSING: under/strike width, feather, capping}
532                 \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} ( type == \hyperlink{classOkular_1_1Annotation_af71b46e37d5f850b97d5c4de3be9aac0a03e002f9ae62005b2d7c7f1445507501}{Okular::Annotation::AHighlight} )
533                 \{
534                     \textcolor{comment}{// get the annotation}
535                     \hyperlink{classOkular_1_1HighlightAnnotation}{Okular::HighlightAnnotation} * ha = (
      \hyperlink{classOkular_1_1HighlightAnnotation}{Okular::HighlightAnnotation} *) a;
536                     \hyperlink{classOkular_1_1HighlightAnnotation_a63d2488735d1d6320e2e118743243999}{Okular::HighlightAnnotation::HighlightType} 
      type = ha->\hyperlink{classOkular_1_1HighlightAnnotation_a3e95972aebea730877a033f8b2908b90}{highlightType}();
537 
538                     \textcolor{comment}{// draw each quad of the annotation}
539                     \textcolor{keywordtype}{int} quads = ha->\hyperlink{classOkular_1_1HighlightAnnotation_ac0099fec5f383ea7296b86db15b6c08c}{highlightQuads}().size();
540                     \textcolor{keywordflow}{for} ( \textcolor{keywordtype}{int} q = 0; q < quads; q++ )
541                     \{
542                         NormalizedPath path;
543                         \textcolor{keyword}{const} \hyperlink{classOkular_1_1HighlightAnnotation_1_1Quad}{Okular::HighlightAnnotation::Quad} & quad = 
      ha->\hyperlink{classOkular_1_1HighlightAnnotation_ac0099fec5f383ea7296b86db15b6c08c}{highlightQuads}()[ q ];
544                         \textcolor{comment}{// normalize page point to image}
545                         \textcolor{keywordflow}{for} ( \textcolor{keywordtype}{int} i = 0; i < 4; i++ )
546                         \{
547                             \hyperlink{classOkular_1_1NormalizedPoint}{Okular::NormalizedPoint} point;
548                             point.\hyperlink{classOkular_1_1NormalizedPoint_a857f49b9bc7712430d167472ef9dbd94}{x} = (quad.\hyperlink{classOkular_1_1HighlightAnnotation_1_1Quad_acb6ab9f7ca3003937f7829941f5a0d52}{transformedPoint}( i ).
      \hyperlink{classOkular_1_1NormalizedPoint_a857f49b9bc7712430d167472ef9dbd94}{x} - xOffset) * xScale;
549                             point.\hyperlink{classOkular_1_1NormalizedPoint_ac2276daabda627d5f82bb1532c293047}{y} = (quad.\hyperlink{classOkular_1_1HighlightAnnotation_1_1Quad_acb6ab9f7ca3003937f7829941f5a0d52}{transformedPoint}( i ).
      \hyperlink{classOkular_1_1NormalizedPoint_ac2276daabda627d5f82bb1532c293047}{y} - yOffset) * yScale;
550                             path.append( point );
551                         \}
552                         \textcolor{comment}{// draw the normalized path into image}
553                         \textcolor{keywordflow}{switch} ( type )
554                         \{
555                             \textcolor{comment}{// highlight the whole rect}
556                             \textcolor{keywordflow}{case} \hyperlink{classOkular_1_1HighlightAnnotation_a63d2488735d1d6320e2e118743243999a250833fcd89a56dd46955dc287e1a3af}{Okular::HighlightAnnotation::Highlight}
      :
557                                 drawShapeOnImage( backImage, path, \textcolor{keyword}{true}, Qt::NoPen, acolor, pageScale, 
      Multiply );
558                                 \textcolor{keywordflow}{break};
559                             \textcolor{comment}{// highlight the bottom part of the rect}
560                             \textcolor{keywordflow}{case} \hyperlink{classOkular_1_1HighlightAnnotation_a63d2488735d1d6320e2e118743243999ad02aabccfaaea6082d9402b01e6ae9b8}{Okular::HighlightAnnotation::Squiggly}
      :
561                                 path[ 3 ].x = ( path[ 0 ].x + path[ 3 ].x ) / 2.0;
562                                 path[ 3 ].y = ( path[ 0 ].y + path[ 3 ].y ) / 2.0;
563                                 path[ 2 ].x = ( path[ 1 ].x + path[ 2 ].x ) / 2.0;
564                                 path[ 2 ].y = ( path[ 1 ].y + path[ 2 ].y ) / 2.0;
565                                 drawShapeOnImage( backImage, path, \textcolor{keyword}{true}, Qt::NoPen, acolor, pageScale, 
      Multiply );
566                                 \textcolor{keywordflow}{break};
567                             \textcolor{comment}{// make a line at 3/4 of the height}
568                             \textcolor{keywordflow}{case} \hyperlink{classOkular_1_1HighlightAnnotation_a63d2488735d1d6320e2e118743243999a1cb762e7ebfd92add9d8b71106e3fa2c}{Okular::HighlightAnnotation::Underline}
      :
569                                 path[ 0 ].x = ( 3 * path[ 0 ].x + path[ 3 ].x ) / 4.0;
570                                 path[ 0 ].y = ( 3 * path[ 0 ].y + path[ 3 ].y ) / 4.0;
571                                 path[ 1 ].x = ( 3 * path[ 1 ].x + path[ 2 ].x ) / 4.0;
572                                 path[ 1 ].y = ( 3 * path[ 1 ].y + path[ 2 ].y ) / 4.0;
573                                 path.pop\_back();
574                                 path.pop\_back();
575                                 drawShapeOnImage( backImage, path, \textcolor{keyword}{false}, QPen( acolor, 2 ), QBrush(), 
      pageScale );
576                                 \textcolor{keywordflow}{break};
577                             \textcolor{comment}{// make a line at 1/2 of the height}
578                             \textcolor{keywordflow}{case} \hyperlink{classOkular_1_1HighlightAnnotation_a63d2488735d1d6320e2e118743243999afcdb9513e4039b7239d89f351f8aff85}{Okular::HighlightAnnotation::StrikeOut}
      :
579                                 path[ 0 ].x = ( path[ 0 ].x + path[ 3 ].x ) / 2.0;
580                                 path[ 0 ].y = ( path[ 0 ].y + path[ 3 ].y ) / 2.0;
581                                 path[ 1 ].x = ( path[ 1 ].x + path[ 2 ].x ) / 2.0;
582                                 path[ 1 ].y = ( path[ 1 ].y + path[ 2 ].y ) / 2.0;
583                                 path.pop\_back();
584                                 path.pop\_back();
585                                 drawShapeOnImage( backImage, path, \textcolor{keyword}{false}, QPen( acolor, 2 ), QBrush(), 
      pageScale );
586                                 \textcolor{keywordflow}{break};
587                         \}
588                     \}
589                 \}
590                 \textcolor{comment}{// draw InkAnnotation MISSING:invar width, PENTRACER}
591                 \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} ( type == \hyperlink{classOkular_1_1Annotation_af71b46e37d5f850b97d5c4de3be9aac0a4ed60063584ceb146c2a378f0df4ed37}{Okular::Annotation::AInk} )
592                 \{
593                     \textcolor{comment}{// get the annotation}
594                     \hyperlink{classOkular_1_1InkAnnotation}{Okular::InkAnnotation} * ia = (
      \hyperlink{classOkular_1_1InkAnnotation}{Okular::InkAnnotation} *) a;
595 
596                     \textcolor{comment}{// draw each ink path}
597                     \textcolor{keyword}{const} \hyperlink{classQList}{QList< QLinkedList<Okular::NormalizedPoint>}
       > transformedInkPaths = ia->\hyperlink{classOkular_1_1InkAnnotation_aaefc02004360e97d31919ea1516ab736}{transformedInkPaths}();
598 
599                     \textcolor{keyword}{const} QPen inkPen = buildPen( a, a->\hyperlink{classOkular_1_1Annotation_ae1f845ddbd6d524b2b388c6c9ef26423}{style}().\hyperlink{classOkular_1_1Annotation_1_1Style_a5a8e23f3a4f95e25f45770937dc82948}{width}(), acolor );
600 
601                     \textcolor{keywordtype}{int} paths = transformedInkPaths.size();
602                     \textcolor{keywordflow}{for} ( \textcolor{keywordtype}{int} p = 0; p < paths; p++ )
603                     \{
604                         NormalizedPath path;
605                         \textcolor{keyword}{const} \hyperlink{classQLinkedList}{QLinkedList<Okular::NormalizedPoint>} & 
      inkPath = transformedInkPaths[ p ];
606 
607                         \textcolor{comment}{// normalize page point to image}
608                         \hyperlink{classQLinkedList}{QLinkedList<Okular::NormalizedPoint>::const\_iterator}
       pIt = inkPath.constBegin(), pEnd = inkPath.constEnd();
609                         \textcolor{keywordflow}{for} ( ; pIt != pEnd; ++pIt )
610                         \{
611                             \textcolor{keyword}{const} \hyperlink{classOkular_1_1NormalizedPoint}{Okular::NormalizedPoint} & inkPoint = *pIt;
612                             \hyperlink{classOkular_1_1NormalizedPoint}{Okular::NormalizedPoint} point;
613                             point.\hyperlink{classOkular_1_1NormalizedPoint_a857f49b9bc7712430d167472ef9dbd94}{x} = (inkPoint.\hyperlink{classOkular_1_1NormalizedPoint_a857f49b9bc7712430d167472ef9dbd94}{x} - xOffset) * xScale;
614                             point.\hyperlink{classOkular_1_1NormalizedPoint_ac2276daabda627d5f82bb1532c293047}{y} = (inkPoint.\hyperlink{classOkular_1_1NormalizedPoint_ac2276daabda627d5f82bb1532c293047}{y} - yOffset) * yScale;
615                             path.append( point );
616                         \}
617                         \textcolor{comment}{// draw the normalized path into image}
618                         drawShapeOnImage( backImage, path, \textcolor{keyword}{false}, inkPen, QBrush(), pageScale );
619                     \}
620                 \}
621             \} \textcolor{comment}{// end current annotation drawing}
622         \}
623 
624         \textcolor{keywordflow}{if}(viewPortPoint)
625         \{
626             QPainter painter(&backImage);
627             painter.translate( -limits.left(), -limits.top() );
628             painter.setPen( QApplication::palette().color( QPalette::Active, QPalette::Highlight ) );
629             painter.drawLine( 0, viewPortPoint->\hyperlink{classOkular_1_1NormalizedPoint_ac2276daabda627d5f82bb1532c293047}{y} * scaledHeight + 1, scaledWidth - 1, viewPortPoint->
      \hyperlink{classOkular_1_1NormalizedPoint_ac2276daabda627d5f82bb1532c293047}{y} * scaledHeight + 1 );
630 \textcolor{comment}{// ROTATION CURRENTLY NOT IMPLEMENTED}
631 \textcolor{comment}{/*}
632 \textcolor{comment}{            if( page->rotation() == Okular::Rotation0)}
633 \textcolor{comment}{            \{}
634 \textcolor{comment}{}
635 \textcolor{comment}{            \}}
636 \textcolor{comment}{            else if(page->rotation() == Okular::Rotation270)}
637 \textcolor{comment}{            \{}
638 \textcolor{comment}{                painter.drawLine( viewPortPoint->y * scaledHeight + 1, 0, viewPortPoint->y * scaledHeight +
       1, scaledWidth - 1);}
639 \textcolor{comment}{            \}}
640 \textcolor{comment}{            else if(page->rotation() == Okular::Rotation180)}
641 \textcolor{comment}{            \{}
642 \textcolor{comment}{                painter.drawLine( 0, (1.0 - viewPortPoint->y) * scaledHeight - 1, scaledWidth - 1, (1.0 -
       viewPortPoint->y) * scaledHeight - 1 );}
643 \textcolor{comment}{            \}}
644 \textcolor{comment}{            else if(page->rotation() == Okular::Rotation90) // not right, rotation clock-wise}
645 \textcolor{comment}{            \{}
646 \textcolor{comment}{                painter.drawLine( scaledWidth - (viewPortPoint->y * scaledHeight + 1), 0, scaledWidth -
       (viewPortPoint->y * scaledHeight + 1), scaledWidth - 1);}
647 \textcolor{comment}{            \}}
648 \textcolor{comment}{*/}
649         \}
650 
651         \textcolor{comment}{// 4B.5. create the back pixmap converting from the local image}
652         backPixmap = \textcolor{keyword}{new} QPixmap( QPixmap::fromImage( backImage ) );
653 
654         \textcolor{comment}{// 4B.6. create a painter over the pixmap and set it as the active one}
655         mixedPainter = \textcolor{keyword}{new} QPainter( backPixmap );
656         mixedPainter->translate( -limits.left(), -limits.top() );
657     \}
658 
660     \textcolor{keywordflow}{if} ( unbufferedAnnotations )
661     \{
662         \textcolor{comment}{// iterate over annotations and paint AText, AGeom, AStamp}
663         \hyperlink{classQList}{QList< Okular::Annotation * >::const\_iterator} aIt = 
      unbufferedAnnotations->constBegin(), aEnd = unbufferedAnnotations->constEnd();
664         \textcolor{keywordflow}{for} ( ; aIt != aEnd; ++aIt )
665         \{
666             \hyperlink{classOkular_1_1Annotation}{Okular::Annotation} * a = *aIt;
667 
668             \textcolor{comment}{// honor opacity settings on supported types}
669             \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} opacity = (\textcolor{keywordtype}{unsigned} int)( 255.0 * a->\hyperlink{classOkular_1_1Annotation_ae1f845ddbd6d524b2b388c6c9ef26423}{style}().
      \hyperlink{classOkular_1_1Annotation_1_1Style_abb17b057d91f128793b3fa3d4b556a45}{opacity}() );
670             \textcolor{comment}{// skip the annotation drawing if all the annotation is fully}
671             \textcolor{comment}{// transparent, but not with text annotations}
672             \textcolor{keywordflow}{if} ( opacity <= 0 && a->subType() != \hyperlink{classOkular_1_1Annotation_af71b46e37d5f850b97d5c4de3be9aac0a48f93d5a9352abc4e38a45f69075e504}{Okular::Annotation::AText} )
673                 \textcolor{keywordflow}{continue};
674 
675             QColor acolor = a->\hyperlink{classOkular_1_1Annotation_ae1f845ddbd6d524b2b388c6c9ef26423}{style}().\hyperlink{classOkular_1_1Annotation_1_1Style_a2c32cb2b41ef8732ddcd3d3dffc20b7d}{color}();
676             \textcolor{keywordflow}{if} ( !acolor.isValid() )
677                 acolor = Qt::yellow;
678             acolor.setAlpha( opacity );
679 
680             \textcolor{comment}{// get annotation boundary and drawn rect}
681             QRect annotBoundary = a->\hyperlink{classOkular_1_1Annotation_a950ea9c7993878729eb4b6b0ea922436}{transformedBoundingRectangle}().
      \hyperlink{classOkular_1_1NormalizedRect_a006897c5fcff2c3a97b4141f1a967513}{geometry}( scaledWidth, scaledHeight ).translated( -scaledCrop.topLeft() );
682             QRect annotRect = annotBoundary.intersect( limits );
683             QRect innerRect( annotRect.left() - annotBoundary.left(), annotRect.top() -
684                     annotBoundary.top(), annotRect.width(), annotRect.height() );
685 
686             \hyperlink{classOkular_1_1Annotation_af71b46e37d5f850b97d5c4de3be9aac0}{Okular::Annotation::SubType} type = a->
      \hyperlink{classOkular_1_1Annotation_af9833449767eacd740f377e69a1fdd48}{subType}();
687 
688             \textcolor{comment}{// draw TextAnnotation}
689             \textcolor{keywordflow}{if} ( type == \hyperlink{classOkular_1_1Annotation_af71b46e37d5f850b97d5c4de3be9aac0a48f93d5a9352abc4e38a45f69075e504}{Okular::Annotation::AText} )
690             \{
691                 \hyperlink{classOkular_1_1TextAnnotation}{Okular::TextAnnotation} * text = (
      \hyperlink{classOkular_1_1TextAnnotation}{Okular::TextAnnotation} *)a;
692                 \textcolor{keywordflow}{if} ( text->\hyperlink{classOkular_1_1TextAnnotation_acf75a9a22542d3008a486298972e6dcf}{textType}() == \hyperlink{classOkular_1_1TextAnnotation_af560204454bf812797bc95bea730b06ea2a746e9125e8cf53627335a8af01b998}{Okular::TextAnnotation::InPlace}
       )
693                 \{
694                     QImage image( annotBoundary.size(), QImage::Format\_ARGB32 );
695                     image.fill( acolor.rgba() );
696                     QPainter painter( &image );
697                     painter.setPen( Qt::black );
698                     painter.setFont( text->\hyperlink{classOkular_1_1TextAnnotation_aa48f194058046e70141412a5e85e7199}{textFont}() );
699                     Qt::AlignmentFlag halign = ( text->\hyperlink{classOkular_1_1TextAnnotation_ada96fce5c424867d6b48a8ae39a8cace}{inplaceAlignment}() == 1 ? 
      Qt::AlignHCenter : ( text->\hyperlink{classOkular_1_1TextAnnotation_ada96fce5c424867d6b48a8ae39a8cace}{inplaceAlignment}() == 2 ? Qt::AlignRight : Qt::AlignLeft ) );
700                     \textcolor{keyword}{const} \textcolor{keywordtype}{double} invXScale = (double)page->\hyperlink{classOkular_1_1Page_a57114e88281da2a51b1bb0d5d4996d53}{width}() / scaledWidth;
701                     \textcolor{keyword}{const} \textcolor{keywordtype}{double} invYScale = (double)page->\hyperlink{classOkular_1_1Page_a67246a32b3e625946eb5c685b8372a4f}{height}() / scaledHeight;
702                     painter.scale( 1 / invXScale, 1 / invYScale );
703                     painter.drawText( 2 * invXScale, 2 * invYScale,
704                                       (image.width() - 2) * invXScale,
705                                       (image.height() - 2) * invYScale,
706                                       Qt::AlignTop | halign | Qt::TextWordWrap,
707                                       text->\hyperlink{classOkular_1_1Annotation_a3b0c9fcbe9d01e06bfcc7216d0035908}{contents}() );
708                     painter.resetTransform();
709                     painter.drawRect( 0, 0, image.width() - 1, image.height() - 1 );
710                     painter.end();
711 
712                     mixedPainter->drawImage( annotBoundary.topLeft(), image );
713                 \}
714                 \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} ( text->\hyperlink{classOkular_1_1TextAnnotation_acf75a9a22542d3008a486298972e6dcf}{textType}() == 
      \hyperlink{classOkular_1_1TextAnnotation_af560204454bf812797bc95bea730b06eaf7d7133e8e4850bf030e108537a9887b}{Okular::TextAnnotation::Linked} )
715                 \{
716                 \textcolor{comment}{// get pixmap, colorize and alpha-blend it}
717                     QString path;
718                     QPixmap pixmap = \hyperlink{namespaceGuiUtils_aa855f96a43d2d14c51acb8282d775d0a}{GuiUtils::iconLoader}()->loadIcon( text->
      \hyperlink{classOkular_1_1TextAnnotation_a40844236e2ea8684a6b439c2c3784821}{textIcon}().toLower(), KIconLoader::User, 32, KIconLoader::DefaultState, QStringList(), &path, true 
      );
719                     \textcolor{keywordflow}{if} ( path.isEmpty() )
720                         pixmap = \hyperlink{namespaceGuiUtils_aa855f96a43d2d14c51acb8282d775d0a}{GuiUtils::iconLoader}()->loadIcon( text->
      \hyperlink{classOkular_1_1TextAnnotation_a40844236e2ea8684a6b439c2c3784821}{textIcon}().toLower(), KIconLoader::NoGroup, 32 );
721                     QImage scaledImage;
722                     QRect annotBoundary2 = QRect( annotBoundary.topLeft(), QSize( 
      \hyperlink{pagepainter_8cpp_a32fe52c433b27892263587c64567dc5a}{TEXTANNOTATION\_ICONSIZE}, \hyperlink{pagepainter_8cpp_a32fe52c433b27892263587c64567dc5a}{TEXTANNOTATION\_ICONSIZE} ) );
723                     QRect annotRect2 = annotBoundary2.intersect( limits );
724                     QRect innerRect2( annotRect2.left() - annotBoundary2.left(), annotRect2.top() -
725                     annotBoundary2.top(), annotRect2.width(), annotRect2.height() );
726                     scalePixmapOnImage( scaledImage, &pixmap,
727                                         \hyperlink{pagepainter_8cpp_a32fe52c433b27892263587c64567dc5a}{TEXTANNOTATION\_ICONSIZE}, 
      \hyperlink{pagepainter_8cpp_a32fe52c433b27892263587c64567dc5a}{TEXTANNOTATION\_ICONSIZE},
728                                         innerRect2, QImage::Format\_ARGB32 );
729                     \textcolor{comment}{// if the annotation color is valid (ie it was set), then}
730                     \textcolor{comment}{// use it to colorize the icon, otherwise the icon will be}
731                     \textcolor{comment}{// "gray"}
732                     \textcolor{keywordflow}{if} ( a->\hyperlink{classOkular_1_1Annotation_ae1f845ddbd6d524b2b388c6c9ef26423}{style}().\hyperlink{classOkular_1_1Annotation_1_1Style_a2c32cb2b41ef8732ddcd3d3dffc20b7d}{color}().isValid() )
733                         \hyperlink{namespaceGuiUtils_a989345da409cc84c3636efad1b174cb5}{GuiUtils::colorizeImage}( scaledImage, a->
      \hyperlink{classOkular_1_1Annotation_ae1f845ddbd6d524b2b388c6c9ef26423}{style}().\hyperlink{classOkular_1_1Annotation_1_1Style_a2c32cb2b41ef8732ddcd3d3dffc20b7d}{color}(), opacity );
734                     pixmap = QPixmap::fromImage( scaledImage );
735 
736                 \textcolor{comment}{// draw the mangled image to painter}
737                     mixedPainter->drawPixmap( annotRect.topLeft(), pixmap );
738                 \}
739 
740             \}
741             \textcolor{comment}{// draw StampAnnotation}
742             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} ( type == \hyperlink{classOkular_1_1Annotation_af71b46e37d5f850b97d5c4de3be9aac0ad542ded420c9b01f44ee923bf28ecd9a}{Okular::Annotation::AStamp} )
743             \{
744                 \hyperlink{classOkular_1_1StampAnnotation}{Okular::StampAnnotation} * stamp = (
      \hyperlink{classOkular_1_1StampAnnotation}{Okular::StampAnnotation} *)a;
745 
746                 \textcolor{comment}{// get pixmap and alpha blend it if needed}
747                 QPixmap pixmap = \hyperlink{namespaceGuiUtils_a5ba797636890ba5fbc39db6a092f4bd5}{GuiUtils::loadStamp}( stamp->
      \hyperlink{classOkular_1_1StampAnnotation_a444978f06c11e4f74fbf1653555b4170}{stampIconName}(), annotBoundary.size() );
748                 \textcolor{keywordflow}{if} ( !pixmap.isNull() ) \textcolor{comment}{// should never happen but can happen on huge sizes}
749                 \{
750                     QImage scaledImage;
751                     scalePixmapOnImage( scaledImage, &pixmap, annotBoundary.width(),
752                                         annotBoundary.height(), innerRect, QImage::Format\_ARGB32 );
753                     \textcolor{keywordflow}{if} ( opacity < 255 )
754                         changeImageAlpha( scaledImage, opacity );
755                     pixmap = QPixmap::fromImage( scaledImage );
756 
757                     \textcolor{comment}{// draw the scaled and al}
758                     mixedPainter->drawPixmap( annotRect.topLeft(), pixmap );
759                 \}
760             \}
761             \textcolor{comment}{// draw GeomAnnotation}
762             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} ( type == \hyperlink{classOkular_1_1Annotation_af71b46e37d5f850b97d5c4de3be9aac0a2c11d328af34f5526fd9e761297fb3c2}{Okular::Annotation::AGeom} )
763             \{
764                 \hyperlink{classOkular_1_1GeomAnnotation}{Okular::GeomAnnotation} * geom = (
      \hyperlink{classOkular_1_1GeomAnnotation}{Okular::GeomAnnotation} *)a;
765                 \textcolor{comment}{// check whether there's anything to draw}
766                 \textcolor{keywordflow}{if} ( geom->\hyperlink{classOkular_1_1Annotation_ae1f845ddbd6d524b2b388c6c9ef26423}{style}().\hyperlink{classOkular_1_1Annotation_1_1Style_a5a8e23f3a4f95e25f45770937dc82948}{width}() || geom->
      \hyperlink{classOkular_1_1GeomAnnotation_a5c84e1cbdf0d2bb6b75b6d6b049af63b}{geometricalInnerColor}().isValid() )
767                 \{
768                     mixedPainter->save();
769                     \textcolor{keyword}{const} \textcolor{keywordtype}{double} width = geom->\hyperlink{classOkular_1_1Annotation_ae1f845ddbd6d524b2b388c6c9ef26423}{style}().\hyperlink{classOkular_1_1Annotation_1_1Style_a5a8e23f3a4f95e25f45770937dc82948}{width}() * 
      \hyperlink{classOkular_1_1Utils_acd9a3685415399561c6cde450ead4710}{Okular::Utils::dpiX}() / ( 72.0 * 2.0 ) * scaledWidth / page->
      \hyperlink{classOkular_1_1Page_a57114e88281da2a51b1bb0d5d4996d53}{width}();
770                     QRectF r( .0, .0, annotBoundary.width(), annotBoundary.height() );
771                     r.adjust( width, width, -width, -width );
772                     r.translate( annotBoundary.topLeft() );
773                     \textcolor{keywordflow}{if} ( geom->\hyperlink{classOkular_1_1GeomAnnotation_a5c84e1cbdf0d2bb6b75b6d6b049af63b}{geometricalInnerColor}().isValid() )
774                     \{
775                         r.adjust( width, width, -width, -width );
776                         \textcolor{keyword}{const} QColor color = geom->\hyperlink{classOkular_1_1GeomAnnotation_a5c84e1cbdf0d2bb6b75b6d6b049af63b}{geometricalInnerColor}();
777                         mixedPainter->setPen( Qt::NoPen );
778                         mixedPainter->setBrush( QColor( color.red(), color.green(), color.blue(), opacity )
       );
779                         \textcolor{keywordflow}{if} ( geom->\hyperlink{classOkular_1_1GeomAnnotation_adeae1cc4b72aed7e9705b51f91f8555f}{geometricalType}() == 
      \hyperlink{classOkular_1_1GeomAnnotation_a511623ed10a8d1f18cfd5987fadee682a5c7718299cc7aad186005a1bd0c86e9e}{Okular::GeomAnnotation::InscribedSquare} )
780                             mixedPainter->drawRect( r );
781                         \textcolor{keywordflow}{else}
782                             mixedPainter->drawEllipse( r );
783                         r.adjust( -width, -width, width, width );
784                     \}
785                     \textcolor{keywordflow}{if} ( geom->\hyperlink{classOkular_1_1Annotation_ae1f845ddbd6d524b2b388c6c9ef26423}{style}().\hyperlink{classOkular_1_1Annotation_1_1Style_a5a8e23f3a4f95e25f45770937dc82948}{width}() ) \textcolor{comment}{// need to check the original size here..}
786                     \{
787                         mixedPainter->setPen( buildPen( a, width * 2, acolor ) );
788                         mixedPainter->setBrush( Qt::NoBrush );
789                         \textcolor{keywordflow}{if} ( geom->\hyperlink{classOkular_1_1GeomAnnotation_adeae1cc4b72aed7e9705b51f91f8555f}{geometricalType}() == 
      \hyperlink{classOkular_1_1GeomAnnotation_a511623ed10a8d1f18cfd5987fadee682a5c7718299cc7aad186005a1bd0c86e9e}{Okular::GeomAnnotation::InscribedSquare} )
790                             mixedPainter->drawRect( r );
791                         \textcolor{keywordflow}{else}
792                             mixedPainter->drawEllipse( r );
793                     \}
794                     mixedPainter->restore();
795                 \}
796             \}
797 
798             \textcolor{comment}{// draw extents rectangle}
799             \textcolor{keywordflow}{if} ( \hyperlink{classOkular_1_1Settings_a2efc0bc534162c18db5c09c91e9b41fb}{Okular::Settings::debugDrawAnnotationRect}() )
800             \{
801                 mixedPainter->setPen( a->\hyperlink{classOkular_1_1Annotation_ae1f845ddbd6d524b2b388c6c9ef26423}{style}().\hyperlink{classOkular_1_1Annotation_1_1Style_a2c32cb2b41ef8732ddcd3d3dffc20b7d}{color}() );
802                 mixedPainter->drawRect( annotBoundary );
803             \}
804         \}
805     \}
806 
807     \textcolor{keywordflow}{if} ( boundingRectOnlyAnn )
808     \{
809         QRect annotBoundary = boundingRectOnlyAnn->\hyperlink{classOkular_1_1Annotation_a950ea9c7993878729eb4b6b0ea922436}{transformedBoundingRectangle}
      ().\hyperlink{classOkular_1_1NormalizedRect_a006897c5fcff2c3a97b4141f1a967513}{geometry}( scaledWidth, scaledHeight ).translated( -scaledCrop.topLeft() );
810         mixedPainter->setPen( Qt::DashLine );
811         mixedPainter->drawRect( annotBoundary );
812     \}
813 
815     \textcolor{keywordflow}{if} ( enhanceLinks || enhanceImages )
816     \{
817         mixedPainter->save();
818         mixedPainter->scale( scaledWidth, scaledHeight );
819         mixedPainter->translate( -crop.\hyperlink{classOkular_1_1NormalizedRect_a76336fe9d733f2b559cf8df3ef48f9e7}{left}, -crop.\hyperlink{classOkular_1_1NormalizedRect_acfb70f6417c993508d50090b512cb954}{top} );
820 
821         QColor normalColor = QApplication::palette().color( QPalette::Active, QPalette::Highlight );
822         \textcolor{comment}{// enlarging limits for intersection is like growing the 'rectGeometry' below}
823         QRect limitsEnlarged = limits;
824         limitsEnlarged.adjust( -2, -2, 2, 2 );
825         \textcolor{comment}{// draw rects that are inside the 'limits' paint region as opaque rects}
826         \hyperlink{classQLinkedList}{QLinkedList< Okular::ObjectRect * >::const\_iterator}
       lIt = page->m\_rects.constBegin(), lEnd = page->m\_rects.constEnd();
827         \textcolor{keywordflow}{for} ( ; lIt != lEnd; ++lIt )
828         \{
829             \hyperlink{classOkular_1_1ObjectRect}{Okular::ObjectRect} * rect = *lIt;
830             \textcolor{keywordflow}{if} ( (enhanceLinks && rect->\hyperlink{classOkular_1_1ObjectRect_a1c61e4737530a2c15ad93c8764917a14}{objectType}() == 
      \hyperlink{classOkular_1_1ObjectRect_a2f77f7653306bae90bfb68277aaafe16a2ad02138861dfdc8bc2a0c29bae5bed2}{Okular::ObjectRect::Action}) ||
831                  (enhanceImages && rect->\hyperlink{classOkular_1_1ObjectRect_a1c61e4737530a2c15ad93c8764917a14}{objectType}() == 
      \hyperlink{classOkular_1_1ObjectRect_a2f77f7653306bae90bfb68277aaafe16a1384fe70201a84f6c3554a7ca6fc84d2}{Okular::ObjectRect::Image}) )
832             \{
833                 \textcolor{keywordflow}{if} ( limitsEnlarged.intersects( rect->\hyperlink{classOkular_1_1ObjectRect_aa6b1c3b6ed093291d5ec7f92b97754ae}{boundingRect}( scaledWidth, scaledHeight )
      .translated( -scaledCrop.topLeft() ) ) )
834                 \{
835                     mixedPainter->strokePath( rect->\hyperlink{classOkular_1_1ObjectRect_a9308d62ab90ca9cb21df729432e4cb92}{region}(), QPen( normalColor ) );
836                 \}
837             \}
838         \}
839         mixedPainter->restore();
840     \}
841 
843     \textcolor{keywordflow}{if} ( useBackBuffer )
844     \{
845         \textcolor{keyword}{delete} mixedPainter;
846         destPainter->drawPixmap( limits.left(), limits.top(), *backPixmap );
847         \textcolor{keyword}{delete} backPixmap;
848     \}
849 
850     \textcolor{comment}{// delete object containers}
851     \textcolor{keyword}{delete} bufferedHighlights;
852     \textcolor{keyword}{delete} bufferedAnnotations;
853     \textcolor{keyword}{delete} unbufferedAnnotations;
854 \}
\end{DoxyCode}
\hypertarget{classPagePainter_a5eea3c770160bf6b62f36ef802b5bd25}{\index{Page\+Painter@{Page\+Painter}!paint\+Page\+On\+Painter@{paint\+Page\+On\+Painter}}
\index{paint\+Page\+On\+Painter@{paint\+Page\+On\+Painter}!Page\+Painter@{Page\+Painter}}
\subsubsection[{paint\+Page\+On\+Painter}]{\setlength{\rightskip}{0pt plus 5cm}void Page\+Painter\+::paint\+Page\+On\+Painter (
\begin{DoxyParamCaption}
\item[{Q\+Painter $\ast$}]{p, }
\item[{const {\bf Okular\+::\+Page} $\ast$}]{page, }
\item[{{\bf Okular\+::\+Document\+Observer} $\ast$}]{observer, }
\item[{int}]{flags, }
\item[{int}]{scaled\+Width, }
\item[{int}]{scaled\+Height, }
\item[{const Q\+Rect \&}]{page\+Limits}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{classPagePainter_a5eea3c770160bf6b62f36ef802b5bd25}


Definition at line 55 of file pagepainter.\+cpp.


\begin{DoxyCode}
57 \{
58         \hyperlink{classPagePainter_af6d636a41a9b1ebe8954c53bf5e3e6ec}{paintCroppedPageOnPainter}( destPainter, page, observer, flags, scaledWidth
      , scaledHeight, limits,
59                                    \hyperlink{classOkular_1_1NormalizedRect}{Okular::NormalizedRect}( 0, 0, 1, 1 ), 0 );
60 \}
\end{DoxyCode}


The documentation for this class was generated from the following files\+:\begin{DoxyCompactItemize}
\item 
ui/\hyperlink{pagepainter_8h}{pagepainter.\+h}\item 
ui/\hyperlink{pagepainter_8cpp}{pagepainter.\+cpp}\end{DoxyCompactItemize}
